# 导出文件名优化报告

## 🎯 优化目标

将导出文件名从简单的时间戳格式改进为包含门店名称的格式，提高文件的可识别性和管理便利性。

## 📋 改进内容

### 1. 文件名格式变更

#### 原格式
```
realtime_inventory_20250130_143022.xlsx
inventory_snapshot_20250130_143022.xlsx
warehouse_stock_2025-01-30.csv
```

#### 新格式
```
北京朝阳店_实时库存_20250130_143022.xlsx
北京朝阳店_库存快照_20250130_143022.xlsx
北京朝阳店_仓库库存_20250130.csv
```

### 2. 特殊字符处理

为确保文件名在所有操作系统中都能正常使用，对门店名称中的特殊字符进行清理：

```javascript
// 清理规则
storeName.replace(/[<>:"/\\|?*]/g, '_')

// 示例转换
"上海/浦东店" -> "上海_浦东店"
"深圳<南山>店" -> "深圳_南山_店"
"广州"天河"店" -> "广州_天河_店"
```

### 3. 代码实现

#### 后端优化

##### 创建辅助函数
```javascript
// express/controllers/inventoryController.js
const getStoreNameForFilename = async (storeId) => {
  try {
    const store = await Store.findById(storeId).select('name').lean();
    if (store && store.name) {
      return store.name.replace(/[<>:"/\\|?*]/g, '_');
    }
  } catch (error) {
    console.warn('获取门店名称失败，使用默认名称:', error.message);
  }
  return '未知门店';
};
```

##### 更新导出函数
- ✅ `exportInventoryRealtimeExcel` - 实时库存导出
- ✅ `exportInventoryExcel` - 库存快照导出

#### 前端优化

##### WarehouseBulkActions组件
- ✅ 添加 `currentStore` prop
- ✅ 更新CSV导出文件名格式
- ✅ 在OptimizedWarehousePage中传递门店信息

### 4. 文件类型对应

| 功能 | 文件格式 | 命名模式 | 示例 |
|------|----------|----------|------|
| 实时库存导出 | Excel (.xlsx) | `{门店名}_实时库存_{时间戳}.xlsx` | `北京朝阳店_实时库存_20250130_143022.xlsx` |
| 库存快照导出 | Excel (.xlsx) | `{门店名}_库存快照_{时间戳}.xlsx` | `北京朝阳店_库存快照_20250130_143022.xlsx` |
| 仓库库存导出 | CSV (.csv) | `{门店名}_仓库库存_{日期}.csv` | `北京朝阳店_仓库库存_20250130.csv` |

### 5. URL编码处理

为确保中文文件名在HTTP响应中正确传输，使用URL编码：

```javascript
res.setHeader("Content-Disposition", `attachment; filename=${encodeURIComponent(filename)}`);
```

## 🧪 测试验证

### 测试脚本
```bash
# 测试文件名生成功能
npm run test:export-filename

# 测试完整导出功能
npm run test:inventory-export
```

### 测试覆盖
- ✅ 正常门店名称处理
- ✅ 特殊字符清理
- ✅ 长文件名处理
- ✅ URL编码验证
- ✅ 多种文件格式支持

## 📊 优化效果

### 用户体验改进
1. **文件识别性**: 文件名直接显示门店信息，无需打开文件即可识别
2. **文件管理**: 多门店环境下便于文件分类和管理
3. **时间追溯**: 保留时间戳信息，便于版本控制

### 技术改进
1. **代码复用**: 创建辅助函数避免重复代码
2. **错误处理**: 门店信息获取失败时的降级处理
3. **字符安全**: 确保文件名在所有系统中兼容

## 🚀 部署建议

### 立即部署
1. 重启后端服务以应用新的文件名生成逻辑
2. 清除前端缓存以获取最新的组件更新
3. 验证各种导出功能的文件名格式

### 监控要点
- 检查文件名是否正确包含门店信息
- 验证特殊字符是否被正确处理
- 确认中文文件名在不同浏览器中的下载表现

## 🔄 后续优化建议

### 功能增强
1. **自定义文件名**: 允许用户自定义导出文件名格式
2. **批量导出**: 支持多门店数据的批量导出
3. **文件压缩**: 大文件自动压缩下载

### 用户体验
1. **下载预览**: 显示即将下载的文件名
2. **下载历史**: 记录用户的导出历史
3. **文件模板**: 提供标准化的文件名模板

---

*优化完成时间: 2025-01-30*
*测试状态: ✅ 通过*
*部署状态: 🟡 待部署*