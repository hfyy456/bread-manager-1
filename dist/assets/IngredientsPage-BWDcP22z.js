import{V,j as e,d as bt,g as yt,r as c,e as vt,b as St,_ as J,s as kt,m as Ct,t as oe,n as wt,X as It,M as zt,K as Pt,ad as l,E as R,ae as o,ah as Xe,ai as Pe,ag as p,i as Ft,ay as $t,ac as fe,ab as se,P as ne,af as I,az as be,aH as ye,aA as ve,aB as U,b4 as re,aj as Tt,a8 as Mt,J as Rt,aG as Se,ak as ke,al as Ce,am as we,an as He,ba as Dt,ao as Ie}from"./format-Cn00hWB_.js";import{I as K,T as At,a as Ee,L as Ot,u as Vt,b as Bt,D as Wt,c as Ht,d as _e,e as Le,f as Ue,g as q,h as d,i as Et,v as _t,j as qe,k as Lt}from"./main-B8pjrUiY.js";const Ut=V(e.jsx("path",{d:"M19 5v14H5V5h14m0-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"}),"CheckBoxOutlineBlank"),qt=V(e.jsx("path",{d:"M19 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.11 0 2-.9 2-2V5c0-1.1-.89-2-2-2zm-9 14l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"}),"CheckBox"),Nt=V(e.jsx("path",{d:"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-2 10H7v-2h10v2z"}),"IndeterminateCheckBox");function Gt(r){return yt("MuiCheckbox",r)}const ze=bt("MuiCheckbox",["root","checked","disabled","indeterminate","colorPrimary","colorSecondary","sizeSmall","sizeMedium"]),Jt=["checkedIcon","color","icon","indeterminate","indeterminateIcon","inputProps","size","className"],Kt=r=>{const{classes:s,indeterminate:a,color:i,size:u}=r,x={root:["root",a&&"indeterminate",`color${oe(i)}`,`size${oe(u)}`]},h=wt(x,Gt,s);return J({},s,h)},Qt=kt(It,{shouldForwardProp:r=>zt(r)||r==="classes",name:"MuiCheckbox",slot:"Root",overridesResolver:(r,s)=>{const{ownerState:a}=r;return[s.root,a.indeterminate&&s.indeterminate,s[`size${oe(a.size)}`],a.color!=="default"&&s[`color${oe(a.color)}`]]}})(({theme:r,ownerState:s})=>J({color:(r.vars||r).palette.text.secondary},!s.disableRipple&&{"&:hover":{backgroundColor:r.vars?`rgba(${s.color==="default"?r.vars.palette.action.activeChannel:r.vars.palette[s.color].mainChannel} / ${r.vars.palette.action.hoverOpacity})`:Pt.alpha(s.color==="default"?r.palette.action.active:r.palette[s.color].main,r.palette.action.hoverOpacity),"@media (hover: none)":{backgroundColor:"transparent"}}},s.color!=="default"&&{[`&.${ze.checked}, &.${ze.indeterminate}`]:{color:(r.vars||r).palette[s.color].main},[`&.${ze.disabled}`]:{color:(r.vars||r).palette.action.disabled}})),Xt=e.jsx(qt,{}),Yt=e.jsx(Ut,{}),Zt=e.jsx(Nt,{}),es=c.forwardRef(function(s,a){var i,u;const x=vt({props:s,name:"MuiCheckbox"}),{checkedIcon:h=Xt,color:b="primary",icon:C=Yt,indeterminate:A=!1,indeterminateIcon:g=Zt,inputProps:f,size:z="medium",className:m}=x,P=St(x,Jt),S=A?g:C,w=A?g:h,B=J({},x,{color:b,indeterminate:A,size:z}),O=Kt(B);return e.jsx(Qt,J({type:"checkbox",inputProps:J({"data-indeterminate":A},f),icon:c.cloneElement(S,{fontSize:(i=S.props.fontSize)!=null?i:z}),checkedIcon:c.cloneElement(w,{fontSize:(u=w.props.fontSize)!=null?u:z}),ownerState:B,ref:a,className:Ct(O.root,m)},P,{classes:O}))}),ts=V(e.jsx("path",{d:"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2M9 17H7v-7h2zm4 0h-2V7h2zm4 0h-2v-4h2z"}),"Assessment"),ss=V([e.jsx("circle",{cx:"12",cy:"12",r:"3.2"},"0"),e.jsx("path",{d:"M9 2 7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5"},"1")],"CameraAlt"),Ne=V(e.jsx("path",{d:"M9.01 14H2v2h7.01v3L13 15l-3.99-4zm5.98-1v-3H22V8h-7.01V5L11 9z"}),"CompareArrows"),Ye=V(e.jsx("path",{d:"M7.41 8.59 12 13.17l4.59-4.58L18 10l-6 6-6-6z"}),"KeyboardArrowDown"),Q=V(e.jsx("path",{d:"M20 4H4v2h16zm1 10v-2l-1-5H4l-1 5v2h1v6h10v-6h4v6h2v-6zm-9 4H6v-4h6z"}),"Store"),Ze=({mainWarehouseStock:r=0,postStock:s=0,unit:a="",compact:i=!1,showTooltip:u=!0})=>{const x=r+s,h=x>0?r/x*100:0,b=x>0?s/x*100:0,C=e.jsx(l,{sx:{display:"flex",flexDirection:i?"row":"column",alignItems:i?"center":"flex-end",gap:i?1:.5,minWidth:i?"auto":80},children:i?e.jsxs(e.Fragment,{children:[e.jsx(R,{icon:e.jsx(K,{}),label:`${r.toFixed(1)}`,size:"small",variant:"outlined",color:"primary",sx:{fontSize:"0.7rem",height:20}}),e.jsx(o,{variant:"caption",color:"text.secondary",children:"+"}),e.jsx(R,{icon:e.jsx(Q,{}),label:`${s.toFixed(1)}`,size:"small",variant:"outlined",color:"secondary",sx:{fontSize:"0.7rem",height:20}})]}):e.jsxs(e.Fragment,{children:[e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(K,{sx:{fontSize:12,color:"primary.main"}}),e.jsx(o,{variant:"body2",sx:{fontSize:"0.75rem",color:"primary.main"},children:r.toFixed(1)})]}),e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(Q,{sx:{fontSize:12,color:"secondary.main"}}),e.jsx(o,{variant:"body2",sx:{fontSize:"0.75rem",color:"secondary.main"},children:s.toFixed(1)})]}),e.jsxs(o,{variant:"caption",sx:{fontSize:"0.7rem",color:"text.secondary",borderTop:"1px solid",borderColor:"divider",pt:.5,mt:.5},children:["= ",x.toFixed(1)," ",a]})]})});return u?e.jsx(At,{title:e.jsxs(l,{children:[e.jsx(o,{variant:"body2",gutterBottom:!0,children:"库存分解详情"}),e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1,mb:.5},children:[e.jsx(K,{sx:{fontSize:16}}),e.jsxs(o,{variant:"body2",children:["主仓库存: ",r.toFixed(2)," ",a," (",h.toFixed(1),"%)"]})]}),e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1,mb:.5},children:[e.jsx(Q,{sx:{fontSize:16}}),e.jsxs(o,{variant:"body2",children:["岗位库存: ",s.toFixed(2)," ",a," (",b.toFixed(1),"%)"]})]}),e.jsxs(o,{variant:"body2",sx:{fontWeight:"bold",mt:1},children:["总库存: ",x.toFixed(2)," ",a]})]}),arrow:!0,placement:"top",children:e.jsx(l,{sx:{cursor:"help"},children:C})}):C},ns=({ingredients:r=[]})=>{const s=c.useMemo(()=>{let a=0,i=0,u=0,x=0,h=0,b=0,C=0,A=r.length;r.forEach(m=>{var ae;const P=((ae=m.mainWarehouseStock)==null?void 0:ae.quantity)||0,S=m.currentStock-P,w=m.price||0;a+=P,i+=S;const B=P*w,O=S*w;x+=B,h+=O,u+=B+O,P>0&&b++,S>0&&C++});const g=a+i,f=g>0?a/g*100:0,z=g>0?i/g*100:0;return{totalMainWarehouse:a,totalPostStock:i,totalStock:g,totalValue:u,mainWarehouseValue:x,postStockValue:h,mainPercentage:f,postPercentage:z,itemsWithMainStock:b,itemsWithPostStock:C,totalItems:A}},[r]);return e.jsx(Xe,{children:e.jsxs(Pe,{children:[e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1,mb:2},children:[e.jsx(ts,{color:"primary"}),e.jsx(o,{variant:"h6",component:"h3",children:"库存统计概览"})]}),e.jsxs(p,{container:!0,spacing:3,children:[e.jsx(p,{item:!0,xs:12,sm:6,md:3,children:e.jsxs(l,{sx:{textAlign:"center",p:2,bgcolor:"primary.50",borderRadius:1},children:[e.jsx(K,{sx:{fontSize:32,color:"primary.main",mb:1}}),e.jsx(o,{variant:"h6",color:"primary.main",children:s.totalMainWarehouse.toFixed(1)}),e.jsx(o,{variant:"body2",color:"text.secondary",children:"主仓总库存"}),e.jsxs(o,{variant:"caption",color:"text.secondary",children:[s.itemsWithMainStock,"/",s.totalItems," 种原料有库存"]}),e.jsxs(o,{variant:"caption",color:"primary.main",sx:{display:"block",fontWeight:"bold"},children:["价值: ¥",s.mainWarehouseValue.toFixed(2)]})]})}),e.jsx(p,{item:!0,xs:12,sm:6,md:3,children:e.jsxs(l,{sx:{textAlign:"center",p:2,bgcolor:"secondary.50",borderRadius:1},children:[e.jsx(Q,{sx:{fontSize:32,color:"secondary.main",mb:1}}),e.jsx(o,{variant:"h6",color:"secondary.main",children:s.totalPostStock.toFixed(1)}),e.jsx(o,{variant:"body2",color:"text.secondary",children:"岗位总库存"}),e.jsxs(o,{variant:"caption",color:"text.secondary",children:[s.itemsWithPostStock,"/",s.totalItems," 种原料有库存"]}),e.jsxs(o,{variant:"caption",color:"secondary.main",sx:{display:"block",fontWeight:"bold"},children:["价值: ¥",s.postStockValue.toFixed(2)]})]})}),e.jsx(p,{item:!0,xs:12,sm:6,md:3,children:e.jsxs(l,{sx:{textAlign:"center",p:2,bgcolor:"success.50",borderRadius:1},children:[e.jsx(Ee,{sx:{fontSize:32,color:"success.main",mb:1}}),e.jsxs(o,{variant:"h6",color:"success.main",children:["¥",s.totalValue.toFixed(2)]}),e.jsx(o,{variant:"body2",color:"text.secondary",children:"库存总价值"}),e.jsx(o,{variant:"caption",color:"text.secondary",children:"全部原料价值"})]})}),e.jsx(p,{item:!0,xs:12,sm:6,md:3,children:e.jsxs(l,{sx:{p:2,bgcolor:"grey.50",borderRadius:1},children:[e.jsx(o,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:"库存分布比例"}),e.jsxs(l,{sx:{mb:1},children:[e.jsxs(l,{sx:{display:"flex",justifyContent:"space-between",mb:.5},children:[e.jsxs(o,{variant:"caption",color:"primary.main",children:["主仓 ",s.mainPercentage.toFixed(1),"%"]}),e.jsxs(o,{variant:"caption",color:"secondary.main",children:["岗位 ",s.postPercentage.toFixed(1),"%"]})]}),e.jsx(Ot,{variant:"determinate",value:s.mainPercentage,sx:{height:8,borderRadius:4,bgcolor:"secondary.light","& .MuiLinearProgress-bar":{bgcolor:"primary.main",borderRadius:4}}})]}),e.jsxs(o,{variant:"caption",color:"text.secondary",children:["总计: ",s.totalStock.toFixed(1)," 单位"]})]})})]}),e.jsxs(l,{sx:{display:"flex",gap:1,mt:2,flexWrap:"wrap"},children:[e.jsx(R,{icon:e.jsx(K,{}),label:`主仓: ${s.itemsWithMainStock}种 ¥${s.mainWarehouseValue.toFixed(2)}`,size:"small",color:"primary",variant:"outlined"}),e.jsx(R,{icon:e.jsx(Q,{}),label:`岗位: ${s.itemsWithPostStock}种 ¥${s.postStockValue.toFixed(2)}`,size:"small",color:"secondary",variant:"outlined"}),e.jsx(R,{icon:e.jsx(Ee,{}),label:`平均价值 ¥${s.totalItems>0?(s.totalValue/s.totalItems).toFixed(2):"0.00"}`,size:"small",color:"success",variant:"outlined"})]})]})})};function Ge(r,s,a){let i=r[a],u=s[a];return(a==="price"||a==="totalValue"||a==="currentStock"||a==="pricePerBaseUnit")&&(i=r[a]||0,u=s[a]||0),u<i?-1:u>i?1:0}function Je(r,s){return r==="desc"?(a,i)=>Ge(a,i,s):(a,i)=>-Ge(a,i,s)}function Ke(r,s){const a=r.map((i,u)=>[i,u]);return a.sort((i,u)=>{const x=s(i[0],u[0]);return x!==0?x:i[1]-u[1]}),a.map(i=>i[0])}const Qe=[{id:"name",numeric:!1,disablePadding:!1,label:"原料名称",sortable:!0,width:"18%"},{id:"post",numeric:!1,disablePadding:!1,label:"负责岗位",sortable:!1,width:"12%"},{id:"stockBreakdown",numeric:!1,disablePadding:!1,label:"库存分解",sortable:!1,align:"right",width:"15%"},{id:"unit",numeric:!1,disablePadding:!1,label:"采购单位",sortable:!0,align:"right",width:"8%"},{id:"specs",numeric:!1,disablePadding:!1,label:"规格",sortable:!1,align:"right",width:"12%"},{id:"price",numeric:!0,disablePadding:!1,label:"采购单价",sortable:!0,align:"right",width:"9%"},{id:"pricePerBaseUnit",numeric:!0,disablePadding:!1,label:"单价/(克)",sortable:!0,align:"right",width:"10%"},{id:"currentStock",numeric:!0,disablePadding:!1,label:"总库存",sortable:!0,align:"right",width:"8%"},{id:"totalValue",numeric:!0,disablePadding:!1,label:"总价值",sortable:!0,align:"right",width:"8%"}],rs=({ingredient:r,posts:s,onRowToggle:a,isExpanded:i})=>{const{name:u,post:x,unit:h,specs:b,price:C,pricePerBaseUnit:A,currentStock:g,totalValue:f,stockByPost:z,mainWarehouseStock:m}=r,P={mb:2,boxShadow:3,"&:hover":{boxShadow:6}};return e.jsxs(Xe,{sx:P,children:[e.jsxs(Pe,{onClick:()=>a(r._id),sx:{cursor:"pointer"},children:[e.jsxs(l,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:1.5},children:[e.jsx(o,{variant:"h6",component:"div",sx:{fontWeight:"bold"},children:u}),e.jsx(R,{label:`总库存: ${g.toFixed(2)} ${h}`,color:g>0?"success":"error",size:"small"})]}),e.jsxs(p,{container:!0,spacing:1,sx:{fontSize:"0.875rem"},children:[e.jsxs(p,{item:!0,xs:12,sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(o,{variant:"body2",color:"text.secondary",children:"库存分解:"}),e.jsx(Ze,{mainWarehouseStock:(m==null?void 0:m.quantity)||0,postStock:g-((m==null?void 0:m.quantity)||0),unit:h,compact:!0,showTooltip:!0})]}),e.jsx(p,{item:!0,xs:6,children:e.jsxs(o,{variant:"body2",color:"text.secondary",children:["总价值: ¥",f.toFixed(2)]})}),e.jsx(p,{item:!0,xs:6,children:e.jsxs(o,{variant:"body2",color:"text.secondary",children:["采购单价: ¥",C.toFixed(2)," / ",h]})}),e.jsx(p,{item:!0,xs:12,children:e.jsxs(o,{variant:"body2",color:"text.secondary",children:["规格: ",b]})})]}),e.jsx(l,{sx:{display:"flex",justifyContent:"center",pt:1,color:"text.secondary"},children:e.jsx(Ye,{sx:{transform:i?"rotate(180deg)":"rotate(0deg)",transition:"transform 0.2s"}})})]}),i&&z&&e.jsxs(Pe,{sx:{pt:0,borderTop:"1px solid #f0f0f0"},children:[e.jsx(o,{sx:{mb:1,fontWeight:500},children:"各岗位库存:"}),e.jsx(l,{sx:{display:"flex",flexWrap:"wrap",gap:1},children:s.map(S=>{const w=z[S.id];return e.jsx(R,{label:`${S.name}: ${w?w.quantity.toFixed(2):"0.00"} ${h}`,variant:"outlined",size:"small"},S.id)})})]})]})},is=()=>{const[r,s]=c.useState([]),[a,i]=c.useState(!0),[u,x]=c.useState(null),{showSnackbar:h}=Vt(),b=Ft(),C=$t(b.breakpoints.up("md")),[A,g]=c.useState({}),[f,z]=c.useState("asc"),[m,P]=c.useState("name"),[S,w]=c.useState(!1),[B,O]=c.useState(!1),[ae,Fe]=c.useState(!1),[$e,Te]=c.useState(!1),[et,tt]=c.useState(""),[ie,Me]=c.useState(!1),[st,ce]=c.useState(!1),[X,nt]=c.useState(""),[Y,rt]=c.useState(""),[E,Re]=c.useState(null),[Z,De]=c.useState(!1),[le,ot]=c.useState([]),[ee,Ae]=c.useState("current"),[F,at]=c.useState(null),[de,it]=c.useState(null),W=ee!=="current",[Oe,Ve]=c.useState(!1),{currentStore:k}=Bt(),Be=t=>{it(de===t?null:t)},_=c.useCallback(async()=>{if(k){i(!0),x(null);try{const t=await fetch("/api/ingredients/list",{method:"POST",headers:{"Content-Type":"application/json","x-current-store-id":k._id,"Cache-Control":"no-cache"},body:JSON.stringify({})});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const n=await t.json();if(n.success&&Array.isArray(n.data)){s(n.data);const j={};n.data.forEach(y=>{let $=0;const v=y.stockByPost;v&&typeof v=="object"&&Object.values(v).forEach(T=>{T!=null&&T.quantity&&($+=T.quantity)}),j[y.name]=$}),g(j),console.log("优化后的库存数据加载完成，原料数量:",n.data.length)}else console.error("获取原料数据失败:",n.message||"Unknown API error"),x(n.message||"获取原料数据失败"),s([]),g({})}catch(t){console.error("获取原料数据错误:",t),x(`获取原料数据错误: ${t.message}`),s([]),g({})}finally{i(!1)}}},[k]),xe=c.useCallback(async()=>{if(k)try{const n=await(await fetch("/api/inventory/snapshots",{headers:{"x-current-store-id":k._id}})).json();n.success&&ot(n.data)}catch(t){console.error("Failed to fetch snapshots list",t)}},[k]),ct=c.useCallback(async t=>{if(t==="current"){_();return}i(!0),x(null);try{const n=await fetch(`/api/inventory/snapshots/${t}`,{headers:{"x-current-store-id":k._id}}),j=await n.json();if(!n.ok||!j.success)throw new Error(j.message||"获取快照详情失败");at(j.data),s([])}catch(n){x(n.message)}finally{i(!1)}},[_,k]);c.useEffect(()=>{k&&(xe(),_())},[xe,_,k]);const lt=t=>{const n=t.target.value;Ae(n),ct(n)},dt=(t,n)=>{z(m===n&&f==="asc"?"desc":"asc"),P(n)},xt=()=>{w(!0)},he=()=>{w(!1)},ht=()=>{if(ee==="current"){h("请先选择一个要还原的历史快照","warning");return}O(!0)},ue=()=>{O(!1)},We=t=>t>0?b.palette.error.main:t<0?b.palette.success.main:b.palette.text.primary,ut=async()=>{if(!X||!Y){h("请选择两个历史快照进行对比","warning");return}De(!0),Re(null);try{const t=await fetch(`/api/ingredients/compare?from=${X}&to=${Y}`);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const n=await t.json();if(n.success)Re(n.data),h("快照对比成功","success");else throw new Error(n.message||"对比失败")}catch(t){h(`对比快照时出错: ${t.message}`,"error")}finally{De(!1)}},mt=async()=>{Fe(!0);try{const n=await(await fetch("/api/inventory/snapshot",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({notes:et,clearData:ie})})).json();if(n.success)h("库存清理操作已成功完成！","success"),xe(),ie&&_(),he(),tt(""),Me(!1);else throw new Error(n.message||"清理库存失败")}catch(t){h(`清理库存时出错: ${t.message}`,"error")}finally{Fe(!1)}},pt=async()=>{ue(),Te(!0);try{const t=await fetch(`/api/inventory/restore/${ee}`,{method:"POST"}),n=await t.json();if(!t.ok)throw new Error(n.message||"操作失败");h(n.message,"success"),_(),Ae("current")}catch(t){h(t.message,"error")}finally{Te(!1)}},D={py:.75,fontSize:"0.875rem"},jt={py:.5,fontSize:"0.875rem",fontWeight:"bold",backgroundColor:"grey.100"},te=c.useMemo(()=>(W&&F?F.ingredients:r).map(n=>{var H;const j=((H=n.mainWarehouseStock)==null?void 0:H.quantity)||0;let y=0;n.stockByPost&&(y=Object.values(n.stockByPost).reduce((je,M)=>je+((M==null?void 0:M.quantity)||0),0));const $=j+y,v=n.price||0,T=$*v,pe=n.baseUnit&&n.norms&&n.price?n.price/(n.norms/(n.baseUnit==="kg"?1e3:1)):0;return{...n,currentStock:$,totalValue:T,pricePerBaseUnit:pe}}),[r,F,W]),{grandTotalInventoryValue:gt,visibleRows:me}=c.useMemo(()=>{let t=0;te.forEach(j=>{t+=j.totalValue||0});const n=Ke(te,Je(f,m));return{grandTotalInventoryValue:t,visibleRows:n}},[te,f,m]);c.useMemo(()=>{const t=W&&F?F.ingredients:r;return Ke(t,Je(f,m))},[f,m,r,F,W]);const ft=async()=>{if(!k){h("请先选择门店","warning");return}Ve(!0);try{const t=await fetch("/api/inventory/export-realtime",{method:"GET",headers:{"x-current-store-id":k._id}});if(!t.ok)throw new Error("导出失败");const n=await t.blob();let j="realtime_inventory.xlsx";const y=t.headers.get("Content-Disposition");y&&y.indexOf("filename=")!==-1&&(j=decodeURIComponent(y.split("filename=")[1].replace(/['\"]/g,"")));const $=window.URL.createObjectURL(n),v=document.createElement("a");v.href=$,v.download=j,document.body.appendChild(v),v.click(),v.remove(),window.URL.revokeObjectURL($),h("导出成功","success")}catch(t){h("导出失败: "+t.message,"error")}finally{Ve(!1)}};return a&&r.length===0&&!F?e.jsx(fe,{maxWidth:"lg",sx:{py:4},children:e.jsxs(l,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"50vh",children:[e.jsx(se,{}),e.jsx(o,{variant:"h6",sx:{ml:2},children:"正在加载原料数据..."})]})}):u?e.jsx(fe,{maxWidth:"lg",sx:{py:4},children:e.jsxs(ne,{elevation:3,sx:{p:3,textAlign:"center",backgroundColor:"error.light"},children:[e.jsx(o,{variant:"h5",color:"error.contrastText",children:"原料数据加载失败"}),e.jsx(o,{color:"error.contrastText",sx:{mt:1},children:u}),e.jsx(I,{variant:"contained",onClick:()=>window.location.reload(),sx:{mt:2},children:"刷新页面"})]})}):e.jsxs(fe,{maxWidth:"xl",sx:{mt:4,mb:4},children:[e.jsxs(l,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,children:[e.jsx(o,{variant:"h5",children:"原料管理"}),e.jsx(I,{variant:"contained",color:"primary",startIcon:e.jsx(Wt,{}),onClick:ft,disabled:Oe,children:Oe?"导出中...":"导出Excel"})]}),e.jsx(o,{variant:"h4",sx:{my:3,textAlign:"center"},children:"原料库存总览"}),e.jsx(l,{sx:{mb:3},children:e.jsx(ns,{ingredients:te})}),e.jsxs(l,{sx:{display:"flex",justifyContent:"center",mb:3,gap:2},children:[e.jsx(I,{variant:"contained",color:"primary",onClick:()=>ce(!0),startIcon:e.jsx(Ne,{}),sx:{py:1.5,px:3},children:"对比快照/计算消耗"}),e.jsx(I,{variant:"contained",color:"secondary",onClick:xt,startIcon:e.jsx(ss,{}),sx:{py:1.5,px:3},children:"清理岗位库存"})]}),e.jsxs(ne,{elevation:2,sx:{p:{xs:1,sm:2},m:{xs:0,sm:1},boxShadow:3},children:[e.jsxs(p,{container:!0,spacing:2,justifyContent:"space-between",alignItems:"center",sx:{mb:2},children:[e.jsx(p,{item:!0,xs:12,md:!0,children:e.jsx(o,{variant:"h4",component:"h1",gutterBottom:!0,sx:{m:0},children:"库存总览"})}),e.jsx(p,{item:!0,xs:12,sm:6,md:4,children:e.jsxs(be,{fullWidth:!0,size:"small",children:[e.jsx(ye,{children:"查看数据"}),e.jsxs(ve,{value:ee,label:"查看数据",onChange:lt,children:[e.jsx(U,{value:"current",children:e.jsx("em",{children:"当前实时库存"})}),le.map(t=>e.jsx(U,{value:t._id,children:`${t.year}年 第${t.weekOfYear}周 (创建于 ${re(new Date(t.createdAt),"yyyy-MM-dd")})`},t._id))]})]})}),e.jsx(p,{item:!0,xs:12,sm:6,md:"auto",children:e.jsx(I,{fullWidth:!0,variant:"outlined",color:"warning",onClick:ht,disabled:$e||!W,children:$e?"正在还原...":"从此快照还原库存"})})]}),e.jsxs(Tt,{direction:"row",spacing:1,alignItems:"center",sx:{mb:2,color:"text.secondary",fontSize:"0.9rem"},children:[e.jsx(Ht,{fontSize:"small"}),e.jsx(o,{variant:"body2",children:W?`您正在查看 ${re(new Date(F==null?void 0:F.createdAt),"yyyy年MM月dd日")} 创建的历史快照。`:"此页面汇总所有岗位盘点的实时库存数据。总库存为各岗位库存之和。"})]}),e.jsxs(o,{variant:"h6",align:"right",sx:{mb:2,fontWeight:"bold"},children:["库存总价值: ¥",gt.toFixed(2)]}),C?e.jsx(_e,{component:ne,sx:{boxShadow:3},children:e.jsxs(Le,{stickyHeader:!0,"aria-label":"ingredients table",children:[e.jsx(Ue,{children:e.jsxs(q,{children:[e.jsx(d,{padding:"checkbox"}),Qe.map(t=>e.jsx(d,{align:t.align||(t.numeric?"right":"left"),padding:t.disablePadding?"none":"normal",sortDirection:m===t.id?f:!1,sx:{...jt,width:t.width},children:t.sortable?e.jsxs(Et,{active:m===t.id,direction:m===t.id?f:"asc",onClick:n=>dt(n,t.id),children:[t.label,m===t.id?e.jsx(l,{component:"span",sx:_t,children:f==="desc"?"sorted descending":"sorted ascending"}):null]}):t.label},t.id))]})}),e.jsx(qe,{children:me.map(t=>{const{_id:n,name:j,unit:y,specs:$,price:v,currentStock:T,totalValue:pe,stockByPost:H,pricePerBaseUnit:je,mainWarehouseStock:M}=t,N=de===n;return e.jsxs(Mt.Fragment,{children:[e.jsxs(q,{hover:!0,onClick:()=>Be(n),sx:{cursor:"pointer","& > *":{borderBottom:N?"none":"unset"},backgroundColor:N?"action.hover":"transparent"},children:[e.jsx(d,{padding:"checkbox",children:e.jsx(Rt,{size:"small",children:e.jsx(Ye,{sx:{transform:N?"rotate(180deg)":"rotate(0deg)",transition:"transform 0.2s"}})})}),e.jsx(d,{sx:D,children:j}),e.jsx(d,{sx:D,children:e.jsx(l,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:Object.entries(Se).map(([G,ge])=>{const L=H&&H[G];return L&&L.quantity>0?e.jsx(R,{label:`${ge}: ${L.quantity.toFixed(2)}`,size:"small",variant:"outlined"},G):null})})}),e.jsx(d,{align:"right",sx:D,children:e.jsx(Ze,{mainWarehouseStock:(M==null?void 0:M.quantity)||0,postStock:T-((M==null?void 0:M.quantity)||0),unit:y,compact:!1,showTooltip:!0})}),e.jsx(d,{align:"right",sx:D,children:y}),e.jsx(d,{align:"right",sx:D,children:$}),e.jsxs(d,{align:"right",sx:D,children:["¥",v.toFixed(2)]}),e.jsxs(d,{align:"right",sx:D,children:["¥",je.toFixed(4)]}),e.jsx(d,{align:"right",sx:D,children:e.jsx(R,{label:T.toFixed(2),color:T>0?"success":"error"})}),e.jsxs(d,{align:"right",sx:D,children:["¥",pe.toFixed(2)]})]}),N&&e.jsx(q,{sx:{backgroundColor:N?"action.hover":"transparent"},children:e.jsx(d,{colSpan:Qe.length+1,sx:{p:0,borderBottom:"1px solid rgba(224, 224, 224, 1)"},children:e.jsxs(l,{sx:{p:2,backgroundColor:"grey.50"},children:[e.jsx(o,{variant:"subtitle2",gutterBottom:!0,children:"各岗位库存详情"}),e.jsx(p,{container:!0,spacing:1,children:Object.entries(Se).map(([G,ge])=>{const L=H&&H[G];return e.jsx(p,{item:!0,xs:12,sm:6,md:4,lg:3,children:e.jsx(R,{label:`${ge}: ${L?L.quantity.toFixed(2):"0.00"} ${y}`,variant:"outlined",sx:{width:"100%",justifyContent:"flex-start",pl:1}})},G)})})]})})})]},n)})})]})}):e.jsx(l,{children:me.map(t=>e.jsx(rs,{ingredient:t,posts:Object.entries(Se).map(([n,j])=>({id:n,name:j})),onRowToggle:Be,isExpanded:de===t._id},t._id))}),me.length===0&&!a&&e.jsx(o,{sx:{textAlign:"center",mt:3,color:"text.secondary"},children:W?"快照数据为空。":"未找到原料数据。请确保API服务正常或数据库中有数据。"})]}),Z&&e.jsx(l,{sx:{display:"flex",justifyContent:"center",my:3},children:e.jsx(se,{})}),e.jsxs(ke,{open:S,onClose:he,children:[e.jsx(Ce,{children:"确认操作"}),e.jsxs(we,{children:[e.jsx(He,{children:"此操作将以当前各岗位填写的库存数量为准，生成一份全店的库存快照，作为后续计算和还原的基准。快照生成后，今日库存将被清零以便开始新的盘点。"}),e.jsx(Dt,{control:e.jsx(es,{checked:ie,onChange:t=>Me(t.target.checked)}),label:"生成快照后清空当前库存（用于新一轮盘点）",sx:{mt:2}})]}),e.jsxs(Ie,{children:[e.jsx(I,{onClick:he,children:"取消"}),e.jsx(I,{onClick:mt,color:"primary",autoFocus:!0,children:"确认生成"})]})]}),e.jsxs(ke,{open:B,onClose:ue,children:[e.jsx(Ce,{children:"确认还原库存"}),e.jsx(we,{children:e.jsx(He,{children:"您确定要从此快照还原库存吗？此操作将覆盖当前的全部库存数据，且无法撤销。"})}),e.jsxs(Ie,{children:[e.jsx(I,{onClick:ue,children:"取消"}),e.jsx(I,{onClick:pt,color:"warning",autoFocus:!0,children:"确认还原"})]})]}),e.jsxs(ke,{open:st,onClose:()=>ce(!1),fullWidth:!0,maxWidth:"md",children:[e.jsx(Ce,{children:"对比快照与消耗分析"}),e.jsxs(we,{children:[e.jsxs(p,{container:!0,spacing:2,sx:{mt:1,mb:2},children:[e.jsx(p,{item:!0,xs:12,sm:6,children:e.jsxs(be,{fullWidth:!0,children:[e.jsx(ye,{children:"起始节点"}),e.jsxs(ve,{value:X,label:"起始节点",onChange:t=>nt(t.target.value),children:[e.jsx(U,{value:"current",children:e.jsx("em",{children:"当前实时库存"})}),le.map(t=>e.jsx(U,{value:t._id,children:re(new Date(t.createdAt),"yyyy-MM-dd HH:mm:ss")},t._id))]})]})}),e.jsx(p,{item:!0,xs:12,sm:6,children:e.jsxs(be,{fullWidth:!0,children:[e.jsx(ye,{children:"结束节点"}),e.jsxs(ve,{value:Y,label:"结束节点",onChange:t=>rt(t.target.value),children:[e.jsx(U,{value:"current",children:e.jsx("em",{children:"当前实时库存"})}),le.map(t=>e.jsx(U,{value:t._id,children:re(new Date(t.createdAt),"yyyy-MM-dd HH:mm:ss")},t._id))]})]})})]}),e.jsx(l,{sx:{display:"flex",justifyContent:"center",mb:2},children:e.jsx(I,{variant:"contained",onClick:ut,disabled:Z||!X||!Y,startIcon:Z?e.jsx(se,{size:20}):e.jsx(Ne,{}),children:"计算消耗"})}),Z&&e.jsx(l,{sx:{display:"flex",justifyContent:"center",my:3},children:e.jsx(se,{})}),E&&e.jsxs(ne,{elevation:2,sx:{p:2},children:[e.jsx(o,{variant:"h6",sx:{mb:2},children:"对比结果"}),e.jsx(_e,{children:e.jsxs(Le,{stickyHeader:!0,size:"small",children:[e.jsx(Ue,{children:e.jsxs(q,{children:[e.jsx(d,{children:"原料名称"}),e.jsx(d,{align:"right",children:"起始库存"}),e.jsx(d,{align:"right",children:"结束库存"}),e.jsx(d,{align:"right",children:"消耗量"}),e.jsx(d,{children:"单位"})]})}),e.jsx(qe,{children:E.items.map(t=>e.jsxs(q,{children:[e.jsx(d,{children:t.ingredientName}),e.jsx(d,{align:"right",children:t.quantityA.toFixed(2)}),e.jsx(d,{align:"right",children:t.quantityB.toFixed(2)}),e.jsx(d,{align:"right",sx:{fontWeight:"bold",color:We(t.consumption)},children:t.consumption.toFixed(2)}),e.jsx(d,{children:t.unit})]},t.ingredientId))}),e.jsx(Lt,{children:e.jsxs(q,{sx:{"& td, & th":{fontWeight:"bold",fontSize:"1rem",borderTop:"2px solid rgba(224, 224, 224, 1)"}},children:[e.jsx(d,{component:"th",children:"总计金额"}),e.jsxs(d,{align:"right",children:["¥",E.totals.valueA.toFixed(2)]}),e.jsxs(d,{align:"right",children:["¥",E.totals.valueB.toFixed(2)]}),e.jsxs(d,{align:"right",sx:{color:We(E.totals.valueConsumption)},children:["¥",E.totals.valueConsumption.toFixed(2)]}),e.jsx(d,{})]})})]})})]})]}),e.jsx(Ie,{children:e.jsx(I,{onClick:()=>ce(!1),children:"关闭"})})]})]})};export{is as default};
