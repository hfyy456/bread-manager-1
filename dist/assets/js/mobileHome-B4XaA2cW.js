import{R as e}from"./client-BoWZ1c0e.js";import{r as t,j as s,az as r,an as n,bm as i,as as a,b as o,B as l,C as c,T as d,A as x,P as h,bn as u,bo as j,t as m,I as p,ao as y,X as g,bp as b,G as f,q as v,bq as w,s as k,b3 as S,af as I,a4 as C,a5 as W,br as E,F as P,e as q,f as A,M as D,W as L,g as R,bs as V,ah as O,a as $,ai as z,aj as F,ak as N,J as H,K as T,L as M,m as _,ax as B,_ as U,O as J,aL as Q,p as G,bt as K,bu as X,bv as Y,D as Z,Z as ee,n as te}from"./mui-DEqbSeLr.js";import{u as se,B as re,R as ne,b as ie}from"./router-BkWWz-Xj.js";import{f as ae,b as oe,e as le,c as ce,d as de}from"./utils-B4UiVrbL.js";import{z as xe}from"./zh-CN-KEGYwzZz.js";/* empty css            */import"./vendor-Cfs_Iq82.js";const he=()=>{const e=se(),[C,W]=t.useState(!0),[E,P]=t.useState(""),[q,A]=t.useState(null),[D,L]=t.useState(null),[R,V]=t.useState(new Date),[O,$]=t.useState(null),{user:z,loading:F,error:N,isFeishuEnv:H,checkingEnv:T}=(()=>{const[e,s]=t.useState(null),[r,n]=t.useState(!0),[i,a]=t.useState(""),[o,l]=t.useState(!1),[c,d]=t.useState(!0);return t.useEffect(()=>{const e=(t="appId",new URLSearchParams(window.location.search).get(t));var t;let r=0;const i=setInterval(()=>{if(window.h5sdk&&window.tt){clearInterval(i),l(!0),d(!1);const r=localStorage.getItem("user");if(r&&"undefined"!==r)try{return s(JSON.parse(r)),void n(!1)}catch(t){localStorage.removeItem("user")}if(!e)return a("URL中缺少appId参数。"),void n(!1);window.h5sdk.ready(()=>{const t=setTimeout(()=>{a("飞书授权请求超时，请稍后重试。"),n(!1)},1e4);window.tt.requestAccess({appID:e,scopeList:[],success:r=>{clearTimeout(t),fetch("/api/feishu/auth",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:r.code,appID:e})}).then(e=>{if(!e.ok)throw new Error("获取用户信息失败");return e.json()}).then(e=>{localStorage.setItem("user",JSON.stringify(e)),s(e)}).catch(e=>{a(e.message)}).finally(()=>n(!1))},fail:e=>{clearTimeout(t),a(`飞书授权失败: ${JSON.stringify(e)}`),n(!1)}})})}else r++,r>=6&&(clearInterval(i),d(!1),l(!1),n(!1))},500);return()=>clearInterval(i)},[]),{user:e,loading:r,error:i,isFeishuEnv:o,checkingEnv:c}})();t.useEffect(()=>{const e=new URLSearchParams(window.location.search).get("store"),t=sessionStorage.getItem("lockedStoreId"),s=localStorage.getItem("defaultStoreId");$(e||t||s)},[]),t.useEffect(()=>{const e=setInterval(()=>{V(new Date)},6e4);return()=>clearInterval(e)},[]);const M=async()=>{var e,t,s,r;if(O)try{const n=ae(new Date,"yyyy-MM-dd"),i=await fetch(`/api/dashboard/summary?periodType=daily&date=${n}`,{headers:{"x-current-store-id":O}});if(!i.ok)throw new Error("获取仪表板数据失败");const a=await i.json();if(a.success){const n={totalPlans:(null==(e=a.data.periodReports)?void 0:e.length)||0,totalQuantity:(null==(t=a.data.periodReports)?void 0:t.reduce((e,t)=>e+(t.totalQuantity||0),0))||0,totalProductionAmount:(null==(s=a.data.periodReports)?void 0:s.reduce((e,t)=>e+(t.totalProductionAmount||0),0))||0,totalWasteAmount:(null==(r=a.data.periodReports)?void 0:r.reduce((e,t)=>e+(t.totalWasteAmount||0),0))||0,avgDailyQuantity:0,avgDailyAmount:0};A(n)}}catch(n){}},_=async()=>{if(O)try{const e=await fetch("/api/warehouse/stock",{headers:{"x-current-store-id":O}});if(!e.ok)throw new Error("获取库存数据失败");const t=await e.json();if(t.success&&Array.isArray(t.data)){const e=t.data,s={totalItems:e.length,lowStockItems:e.filter(e=>{var t;const s=((null==(t=e.mainWarehouseStock)?void 0:t.quantity)||0)+Object.values(e.stockByPost||{}).reduce((e,t)=>e+((null==t?void 0:t.quantity)||0),0);return s>0&&s<=(e.minStock||10)}).length,outOfStockItems:e.filter(e=>{var t;return 0===((null==(t=e.mainWarehouseStock)?void 0:t.quantity)||0)+Object.values(e.stockByPost||{}).reduce((e,t)=>e+((null==t?void 0:t.quantity)||0),0)}).length,totalValue:e.reduce((e,t)=>{var s;return e+(((null==(s=t.mainWarehouseStock)?void 0:s.quantity)||0)+Object.values(t.stockByPost||{}).reduce((e,t)=>e+((null==t?void 0:t.quantity)||0),0))*(t.price||0)},0)};L(s)}}catch(e){}};t.useEffect(()=>{(async()=>{if(O){W(!0),P("");try{await Promise.all([M(),_()])}catch(e){P("数据加载失败，请稍后重试")}finally{W(!1)}}})()},[O]);const B=[{id:"production-stats",title:"生产报损统计",description:"查看生产计划和报损情况",icon:s.jsx(r,{}),color:"#1976d2",onClick:()=>{e("/mobileHome/production-loss")}},{id:"inventory-check",title:"库存盘点",description:"进行库存盘点和管理",icon:s.jsx(n,{}),color:"#388e3c",badge:(null==D?void 0:D.lowStockItems)||0,onClick:()=>{alert("库存盘点功能开发中...")}},{id:"data-dashboard",title:"数据统计",description:"查看经营数据和趋势分析",icon:s.jsx(i,{}),color:"#f57c00",onClick:()=>{alert("数据统计功能开发中...")}},{id:"request-center",title:"申领中心",description:"物料申领和审批管理",icon:s.jsx(a,{}),color:"#7b1fa2",onClick:()=>{alert("申领中心功能开发中...")}}];return T?s.jsx(o,{maxWidth:"sm",sx:{py:4,display:"flex",justifyContent:"center",alignItems:"center",minHeight:"50vh"},children:s.jsxs(l,{textAlign:"center",children:[s.jsx(c,{sx:{mb:2}}),s.jsx(d,{children:"检测飞书环境中..."})]})}):H?F?s.jsx(o,{maxWidth:"sm",sx:{py:4,display:"flex",justifyContent:"center",alignItems:"center",minHeight:"50vh"},children:s.jsxs(l,{textAlign:"center",children:[s.jsx(c,{sx:{mb:2}}),s.jsx(d,{children:"获取用户信息中..."})]})}):N?s.jsx(o,{maxWidth:"sm",sx:{py:4},children:s.jsxs(x,{severity:"error",children:[s.jsx(d,{variant:"h6",gutterBottom:!0,children:"认证失败"}),s.jsx(d,{variant:"body2",children:N})]})}):O?s.jsxs(o,{maxWidth:"sm",sx:{py:2,pb:8},children:[s.jsxs(h,{elevation:2,sx:{p:3,mb:3,borderRadius:2},children:[s.jsxs(l,{display:"flex",alignItems:"center",justifyContent:"space-between",mb:2,children:[s.jsxs(l,{display:"flex",alignItems:"center",children:[s.jsx(u,{src:null==z?void 0:z.avatar,sx:{bgcolor:"primary.main",mr:2},children:(null==z?void 0:z.avatar)?null:s.jsx(j,{})}),s.jsxs(l,{children:[s.jsx(d,{variant:"h6",fontWeight:"bold",children:(null==z?void 0:z.name)||"面包管理系统"}),s.jsxs(d,{variant:"body2",color:"text.secondary",children:["门店ID: ",O]}),H&&s.jsx(m,{label:"飞书用户",size:"small",color:"primary",variant:"outlined",sx:{mt:.5}})]})]}),s.jsx(p,{onClick:async()=>{await Promise.all([M(),_()])},disabled:C,children:s.jsx(y,{})})]}),s.jsx(g,{sx:{my:2}}),s.jsxs(l,{display:"flex",alignItems:"center",justifyContent:"space-between",children:[s.jsxs(l,{children:[s.jsx(d,{variant:"body2",color:"text.secondary",children:"当前时间"}),s.jsx(d,{variant:"h6",children:ae(R,"MM月dd日 HH:mm",{locale:xe})})]}),s.jsx(m,{icon:s.jsx(b,{}),label:ae(R,"EEEE",{locale:xe}),color:"primary",variant:"outlined"})]})]}),C?s.jsx(l,{display:"flex",justifyContent:"center",py:4,children:s.jsx(c,{})}):E?s.jsx(x,{severity:"error",sx:{mb:3},children:E}):s.jsxs(f,{container:!0,spacing:2,sx:{mb:3},children:[s.jsx(f,{item:!0,xs:6,children:s.jsxs(h,{elevation:1,sx:{p:2,textAlign:"center"},children:[s.jsx(d,{variant:"h4",color:"primary.main",fontWeight:"bold",children:(null==D?void 0:D.totalItems)||0}),s.jsx(d,{variant:"body2",color:"text.secondary",children:"库存物料"})]})}),s.jsx(f,{item:!0,xs:6,children:s.jsxs(h,{elevation:1,sx:{p:2,textAlign:"center"},children:[s.jsx(d,{variant:"h4",color:"warning.main",fontWeight:"bold",children:(null==D?void 0:D.lowStockItems)||0}),s.jsx(d,{variant:"body2",color:"text.secondary",children:"低库存预警"})]})}),s.jsx(f,{item:!0,xs:6,children:s.jsxs(h,{elevation:1,sx:{p:2,textAlign:"center"},children:[s.jsxs(d,{variant:"h4",color:"success.main",fontWeight:"bold",children:["¥",((null==D?void 0:D.totalValue)||0).toFixed(0)]}),s.jsx(d,{variant:"body2",color:"text.secondary",children:"库存总价值"})]})}),s.jsx(f,{item:!0,xs:6,children:s.jsxs(h,{elevation:1,sx:{p:2,textAlign:"center"},children:[s.jsx(d,{variant:"h4",color:"error.main",fontWeight:"bold",children:(null==D?void 0:D.outOfStockItems)||0}),s.jsx(d,{variant:"body2",color:"text.secondary",children:"缺货物料"})]})})]}),s.jsx(d,{variant:"h6",fontWeight:"bold",sx:{mb:2},children:"快捷操作"}),s.jsx(f,{container:!0,spacing:2,children:B.map(e=>s.jsx(f,{item:!0,xs:6,children:s.jsx(v,{elevation:2,sx:{height:"100%"},children:s.jsx(w,{onClick:e.onClick,sx:{p:2,height:"100%"},children:s.jsxs(k,{sx:{textAlign:"center",p:0},children:[s.jsxs(l,{position:"relative",display:"inline-block",mb:1,children:[s.jsx(u,{sx:{bgcolor:e.color,width:56,height:56,mx:"auto"},children:e.icon}),e.badge&&e.badge>0&&s.jsx(S,{badgeContent:e.badge,color:"error",sx:{position:"absolute",top:0,right:0}})]}),s.jsx(d,{variant:"subtitle1",fontWeight:"bold",gutterBottom:!0,children:e.title}),s.jsx(d,{variant:"body2",color:"text.secondary",children:e.description})]})})})},e.id))}),s.jsx(l,{mt:4,children:s.jsx(h,{elevation:1,sx:{p:2},children:s.jsxs(l,{display:"flex",alignItems:"center",justifyContent:"space-between",children:[s.jsxs(l,{display:"flex",alignItems:"center",children:[s.jsx(I,{color:"success",sx:{mr:1}}),s.jsx(d,{variant:"body2",children:"系统运行正常"})]}),s.jsxs(d,{variant:"caption",color:"text.secondary",children:["最后更新: ",ae(new Date,"HH:mm")]})]})})})]}):s.jsx(o,{maxWidth:"sm",sx:{py:4},children:s.jsx(x,{severity:"warning",children:"无法获取门店信息，请检查URL参数或重新登录。"})}):s.jsx(o,{maxWidth:"sm",sx:{py:4},children:s.jsxs(x,{severity:"info",sx:{mb:2},children:[s.jsx(d,{variant:"h6",gutterBottom:!0,children:"请在飞书客户端中打开"}),s.jsx(d,{variant:"body2",children:"此页面需要飞书应用环境支持，请复制链接并在飞书中访问。"})]})})},ue=()=>{const[e,n]=t.useState(!0),[i,u]=t.useState(""),[j,w]=t.useState(null),[S,I]=t.useState([]),[Z,ee]=t.useState("all"),[te,se]=t.useState("weekly"),[re,ne]=t.useState(null),[ie,he]=t.useState(!1),[ue,je]=t.useState([]),[me,pe]=t.useState([]),[ye,ge]=t.useState("production"),[be,fe]=t.useState(!1),[ve,we]=t.useState(""),[ke,Se]=t.useState(""),[Ie,Ce]=t.useState(!1),We=[{key:"production",label:"生产报损登记",description:"生产过程中的报损记录",icon:s.jsx(r,{}),color:"#ff9800"},{key:"tasting",label:"品尝报损",description:"产品品尝导致的报损",icon:s.jsx(X,{}),color:"#4caf50"},{key:"closing",label:"打烊报损",description:"营业结束时的报损",icon:s.jsx(b,{}),color:"#2196f3"},{key:"other",label:"其他报损",description:"其他原因导致的报损",icon:s.jsx(Y,{}),color:"#9c27b0"}];t.useEffect(()=>{const e=new URLSearchParams(window.location.search).get("store"),t=sessionStorage.getItem("lockedStoreId"),s=localStorage.getItem("defaultStoreId");ne(e||t||s)},[]);const Ee=t.useCallback(e=>{const t=new Date;let s,r;switch(e){case"daily":s=t,r=t;break;case"weekly":default:s=oe(t,{weekStartsOn:1}),r=le(t,{weekStartsOn:1});break;case"monthly":s=ce(t),r=de(t)}return{startDate:ae(s,"yyyy-MM-dd"),endDate:ae(r,"yyyy-MM-dd")}},[]),Pe=t.useCallback(async()=>{if(re)try{const{startDate:e,endDate:t}=Ee(te),s="all"===Z?"":`&type=${Z}`,r=await fetch(`/api/production-loss/stats?startDate=${e}&endDate=${t}${s}`,{headers:{"x-current-store-id":re}});if(!r.ok)throw new Error("获取报损统计数据失败");const n=await r.json();if(!n.success)throw new Error(n.message||"获取统计数据失败");w(n.data)}catch(e){u(e instanceof Error?e.message:"获取统计数据失败")}},[re,te,Z,Ee]),qe=t.useCallback(async()=>{if(re)try{const{startDate:e,endDate:t}=Ee(te),s="all"===Z?"":`&type=${Z}`,r=await fetch(`/api/production-loss/records?startDate=${e}&endDate=${t}${s}&limit=20`,{headers:{"x-current-store-id":re}});if(!r.ok)throw new Error("获取报损记录失败");const n=await r.json();if(!n.success)throw new Error(n.message||"获取报损记录失败");I(n.data||[])}catch(e){}},[re,Z,te,Ee]),Ae=t.useCallback(async()=>{if(re)try{const e=await fetch("/api/production-loss/products",{headers:{"x-current-store-id":re}});if(!e.ok)throw new Error("获取门店产品失败");const t=await e.json();if(!t.success)throw new Error(t.message||"获取门店产品失败");je(t.data||[])}catch(e){u(e instanceof Error?e.message:"获取门店产品失败")}},[re]);t.useEffect(()=>{(async()=>{if(re){n(!0),u("");try{await Promise.all([Pe(),qe(),Ae()])}catch(e){u("数据加载失败，请稍后重试")}finally{n(!1)}}})()},[re,Pe,qe,Ae]),t.useEffect(()=>{ie&&re&&0===ue.length&&Ae()},[ie,re,ue.length,Ae]);const De=async()=>{await Promise.all([Pe(),qe()])},Le=e=>{if(me.find(t=>t.breadId===e._id))pe(t=>t.map(t=>t.breadId===e._id?{...t,quantity:t.quantity+1,totalValue:(t.quantity+1)*t.unitPrice}:t));else{const t={breadId:e._id,breadName:e.name,quantity:1,unitPrice:e.price,totalValue:e.price,reason:""};pe(e=>[...e,t])}fe(!1)},Re=(e,t)=>{pe(t<=0?t=>t.filter(t=>t.breadId!==e):s=>s.map(s=>s.breadId===e?{...s,quantity:t,totalValue:t*s.unitPrice}:s))},Ve=e=>({production:"生产报损",tasting:"品尝报损",closing:"打烊报损",other:"其他报损"}[e]),Oe=ue.filter(e=>e.name.toLowerCase().includes(ve.toLowerCase())||e.category.toLowerCase().includes(ve.toLowerCase()));me.reduce((e,t)=>e+t.quantity,0),me.reduce((e,t)=>e+t.totalValue,0);const $e=e=>{const t=new URLSearchParams;re&&t.set("store",re),t.set("type",e),window.location.href=`/mobileHome/loss-register?${t.toString()}`},ze=e=>{const t=We.find(t=>t.key===e);return t?t.color:"#666"};return e?s.jsx(o,{maxWidth:"sm",sx:{py:2},children:s.jsx(l,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"50vh",children:s.jsx(c,{})})}):s.jsxs(l,{sx:{pb:2},children:[s.jsx(C,{position:"sticky",sx:{bgcolor:"#1976d2"},children:s.jsxs(W,{children:[s.jsx(p,{edge:"start",color:"inherit",onClick:()=>{window.history.back()},sx:{mr:2},children:s.jsx(E,{})}),s.jsx(d,{variant:"h6",sx:{flexGrow:1},children:"生产报损统计"}),s.jsx(p,{color:"inherit",onClick:De,children:s.jsx(y,{})})]})}),s.jsxs(o,{maxWidth:"sm",sx:{py:2},children:[i&&s.jsx(x,{severity:"error",sx:{mb:2},children:i}),s.jsx(h,{elevation:2,sx:{p:2,mb:2},children:s.jsxs(P,{fullWidth:!0,size:"small",children:[s.jsx(q,{children:"统计周期"}),s.jsxs(A,{value:te,label:"统计周期",onChange:e=>se(e.target.value),children:[s.jsx(D,{value:"daily",children:"今日"}),s.jsx(D,{value:"weekly",children:"本周"}),s.jsx(D,{value:"monthly",children:"本月"})]})]})}),s.jsx(d,{variant:"h6",sx:{mb:2,fontWeight:"bold"},children:"报损类型选择"}),s.jsx(f,{container:!0,spacing:2,sx:{mb:3},children:We.map(e=>s.jsx(f,{item:!0,xs:6,children:s.jsxs(v,{sx:{cursor:"pointer",transition:"all 0.2s",border:Z===e.key?`2px solid ${e.color}`:"1px solid #e0e0e0","&:hover":{transform:"translateY(-2px)",boxShadow:3}},onClick:()=>(e=>{ee(e)})(e.key),children:[s.jsxs(k,{sx:{textAlign:"center",py:2},children:[s.jsx(l,{sx:{color:e.color,mb:1},children:e.icon}),s.jsx(d,{variant:"subtitle2",sx:{fontWeight:"bold",mb:.5},children:e.label}),s.jsx(d,{variant:"caption",color:"text.secondary",children:e.description})]}),s.jsx(L,{sx:{justifyContent:"center",pt:0},children:s.jsx(R,{size:"small",variant:"outlined",sx:{borderColor:e.color,color:e.color},onClick:t=>{t.stopPropagation(),$e(e.key)},children:"立即登记"})})]})},e.key))}),j&&s.jsxs(h,{elevation:2,sx:{p:2,mb:2},children:[s.jsxs(d,{variant:"h6",sx:{mb:2,display:"flex",alignItems:"center"},children:[s.jsx(a,{sx:{mr:1,color:"#ff9800"}}),"统计概览","all"!==Z&&s.jsx(m,{label:Ve(Z),size:"small",sx:{ml:1,bgcolor:ze(Z),color:"white"}})]}),s.jsxs(f,{container:!0,spacing:2,children:[s.jsx(f,{item:!0,xs:6,children:s.jsxs(l,{textAlign:"center",children:[s.jsx(d,{variant:"h4",color:"error",sx:{fontWeight:"bold"},children:j.totalLoss}),s.jsx(d,{variant:"caption",color:"text.secondary",children:"总报损数量"})]})}),s.jsx(f,{item:!0,xs:6,children:s.jsxs(l,{textAlign:"center",children:[s.jsxs(d,{variant:"h4",color:"error",sx:{fontWeight:"bold"},children:["¥",j.totalValue.toFixed(2)]}),s.jsx(d,{variant:"caption",color:"text.secondary",children:"总报损金额"})]})}),"all"===Z&&s.jsxs(s.Fragment,{children:[s.jsx(f,{item:!0,xs:3,children:s.jsxs(l,{textAlign:"center",children:[s.jsx(d,{variant:"h6",sx:{color:"#ff9800"},children:j.productionLoss}),s.jsx(d,{variant:"caption",children:"生产报损"})]})}),s.jsx(f,{item:!0,xs:3,children:s.jsxs(l,{textAlign:"center",children:[s.jsx(d,{variant:"h6",sx:{color:"#4caf50"},children:j.tastingLoss}),s.jsx(d,{variant:"caption",children:"品尝报损"})]})}),s.jsx(f,{item:!0,xs:3,children:s.jsxs(l,{textAlign:"center",children:[s.jsx(d,{variant:"h6",sx:{color:"#2196f3"},children:j.closingLoss}),s.jsx(d,{variant:"caption",children:"打烊报损"})]})}),s.jsx(f,{item:!0,xs:3,children:s.jsxs(l,{textAlign:"center",children:[s.jsx(d,{variant:"h6",sx:{color:"#9c27b0"},children:j.otherLoss}),s.jsx(d,{variant:"caption",children:"其他报损"})]})})]})]}),j.lossRate>0&&s.jsx(l,{sx:{mt:2,p:1,bgcolor:"#fff3e0",borderRadius:1},children:s.jsxs(d,{variant:"body2",sx:{display:"flex",alignItems:"center"},children:[s.jsx(V,{sx:{mr:1,color:"#ff9800",fontSize:16}}),"报损率: ",(100*j.lossRate).toFixed(2),"%"]})})]}),s.jsxs(h,{elevation:2,sx:{mb:2},children:[s.jsx(l,{sx:{p:2,borderBottom:"1px solid #e0e0e0"},children:s.jsx(d,{variant:"h6",children:"最近报损记录"})}),S.length>0?s.jsx(O,{children:S.map((e,t)=>s.jsxs($.Fragment,{children:[s.jsxs(z,{children:[s.jsx(F,{children:s.jsx(l,{sx:{width:8,height:8,borderRadius:"50%",bgcolor:ze(e.type)}})}),s.jsx(N,{primary:s.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1},children:[s.jsx(d,{variant:"subtitle2",children:e.breadName}),s.jsx(m,{label:Ve(e.type),size:"small",sx:{bgcolor:ze(e.type),color:"white",fontSize:"0.7rem"}})]}),secondary:s.jsxs(l,{children:[s.jsxs(d,{variant:"body2",color:"text.secondary",children:["数量: ",e.quantity," | 金额: ¥",e.totalValue.toFixed(2)]}),s.jsx(d,{variant:"caption",color:"text.secondary",children:ae(new Date(e.date),"MM-dd HH:mm",{locale:xe})}),e.reason&&s.jsxs(d,{variant:"caption",color:"text.secondary",sx:{display:"block"},children:["原因: ",e.reason]})]})})]}),t<S.length-1&&s.jsx(g,{})]},e._id))}):s.jsx(l,{sx:{p:3,textAlign:"center"},children:s.jsx(d,{color:"text.secondary",children:"暂无报损记录"})})]}),s.jsxs(h,{elevation:2,sx:{p:2},children:[s.jsx(d,{variant:"h6",sx:{mb:2},children:"快速操作"}),s.jsx(f,{container:!0,spacing:1,children:We.map(e=>s.jsx(f,{item:!0,xs:6,children:s.jsx(R,{fullWidth:!0,variant:"outlined",startIcon:e.icon,sx:{borderColor:e.color,color:e.color,"&:hover":{borderColor:e.color,bgcolor:`${e.color}10`}},onClick:()=>$e(e.key),children:e.label})},`quick-${e.key}`))})]})]}),s.jsxs(H,{open:ie,onClose:()=>he(!1),fullWidth:!0,maxWidth:"sm",children:[s.jsxs(T,{children:["报损登记 - ",Ve(ye)]}),s.jsxs(M,{children:[s.jsxs(P,{fullWidth:!0,sx:{mb:2},children:[s.jsx(q,{children:"报损类型"}),s.jsx(A,{value:ye,label:"报损类型",onChange:e=>ge(e.target.value),children:We.map(e=>s.jsx(D,{value:e.key,children:e.label},e.key))})]}),s.jsx(_,{fullWidth:!0,label:"报损原因（可选）",value:ke,onChange:e=>Se(e.target.value),sx:{mb:2},placeholder:"输入报损原因，将应用到所有项目"}),me.length>0&&s.jsxs(l,{sx:{mb:2},children:[s.jsx(d,{variant:"subtitle2",sx:{mb:1},children:"报损项目列表"}),s.jsx(O,{children:me.map(e=>s.jsxs(z,{children:[s.jsx(N,{primary:e.breadName,secondary:`单价: ¥${e.unitPrice} | 小计: ¥${e.totalValue.toFixed(2)}`}),s.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1},children:[s.jsx(p,{size:"small",onClick:()=>Re(e.breadId,e.quantity-1),children:s.jsx(B,{})}),s.jsx(d,{sx:{minWidth:20,textAlign:"center"},children:e.quantity}),s.jsx(p,{size:"small",onClick:()=>Re(e.breadId,e.quantity+1),children:s.jsx(U,{})})]})]},e.breadId))}),s.jsx(l,{sx:{p:2,bgcolor:"#f5f5f5",borderRadius:1},children:s.jsxs(d,{variant:"subtitle2",children:["总计: ",me.reduce((e,t)=>e+t.quantity,0)," 个 | ¥",me.reduce((e,t)=>e+t.totalValue,0).toFixed(2)]})})]}),s.jsx(R,{fullWidth:!0,variant:"outlined",startIcon:s.jsx(U,{}),onClick:()=>fe(!0),sx:{mb:2},children:"添加面包"})]}),s.jsxs(J,{children:[s.jsx(R,{onClick:()=>he(!1),children:"取消"}),s.jsx(R,{onClick:async()=>{if(0!==me.length){Ce(!0),u("");try{const e={type:ye,date:(new Date).toISOString(),items:me.map(e=>({...e,reason:e.reason||ke||"无"})),totalQuantity:me.reduce((e,t)=>e+t.quantity,0),totalValue:me.reduce((e,t)=>e+t.totalValue,0)},t=await fetch("/api/production-loss/register",{method:"POST",headers:{"Content-Type":"application/json","x-current-store-id":re},body:JSON.stringify(e)});if(!t.ok)throw new Error("提交报损记录失败");const s=await t.json();if(!s.success)throw new Error(s.message||"提交报损记录失败");pe([]),Se(""),he(!1),De()}catch(e){u(e instanceof Error?e.message:"提交报损记录失败")}finally{Ce(!1)}}else u("请至少添加一个报损项目")},variant:"contained",disabled:0===me.length||Ie,startIcon:Ie?s.jsx(c,{size:16}):s.jsx(Q,{}),children:Ie?"提交中...":"提交报损"})]})]}),s.jsxs(H,{open:be,onClose:()=>fe(!1),fullWidth:!0,maxWidth:"sm",children:[s.jsx(T,{children:"选择面包"}),s.jsxs(M,{children:[s.jsx(_,{fullWidth:!0,placeholder:"搜索面包...",value:ve,onChange:e=>we(e.target.value),InputProps:{startAdornment:s.jsx(G,{sx:{mr:1,color:"text.secondary"}})},sx:{mb:2}}),s.jsxs(O,{children:[Oe.map(e=>s.jsxs(z,{button:!0,onClick:()=>Le(e),children:[s.jsx(N,{primary:e.name,secondary:`${e.category} | ¥${e.price}`}),s.jsx(K,{children:s.jsx(p,{edge:"end",onClick:()=>Le(e),children:s.jsx(U,{})})})]},e._id)),0===Oe.length&&s.jsx(l,{sx:{p:2,textAlign:"center"},children:s.jsx(d,{color:"text.secondary",children:ve?"未找到匹配的面包类型":"暂无面包类型数据"})})]})]}),s.jsx(J,{children:s.jsx(R,{onClick:()=>fe(!1),children:"关闭"})})]})]})},je=()=>{const[e,r]=t.useState(!1),[n,i]=t.useState(""),[a,u]=t.useState(""),[j,y]=t.useState(null),[b,v]=t.useState("production"),[w,k]=t.useState([]),[S,I]=t.useState(!1),[L,V]=t.useState(""),[F,B]=t.useState([]),[X,Y]=t.useState(""),[se,re]=t.useState(!1),ne={production:{label:"生产报损",color:"#ff9800"},tasting:{label:"品尝报损",color:"#4caf50"},closing:{label:"打烊报损",color:"#2196f3"},other:{label:"其他报损",color:"#9c27b0"}};t.useEffect(()=>{const e=new URLSearchParams(window.location.search),t=e.get("store"),s=e.get("type"),r=sessionStorage.getItem("lockedStoreId"),n=localStorage.getItem("defaultStoreId");y(t||r||n),s&&["production","tasting","closing","other"].includes(s)&&v(s)},[]);const ie=t.useCallback(async()=>{if(j)try{r(!0);const e=await fetch("/api/production-loss/products",{headers:{"x-current-store-id":j}});if(!e.ok)throw new Error("获取门店产品失败");const t=await e.json();if(!t.success)throw new Error(t.message||"获取产品列表失败");k(t.data||[])}catch(e){i(e instanceof Error?e.message:"获取产品列表失败")}finally{r(!1)}},[j]);t.useEffect(()=>{j&&ie()},[j,ie]);const ae=w.filter(e=>e.name.toLowerCase().includes(L.toLowerCase())),oe=(e,t)=>{t<=0?le(e):B(s=>s.map(s=>s.productId===e?{...s,quantity:t,totalValue:t*s.unitPrice}:s))},le=e=>{B(t=>t.filter(t=>t.productId!==e))},ce=F.reduce((e,t)=>e+t.quantity,0),de=F.reduce((e,t)=>e+t.totalValue,0);return j?s.jsxs(l,{sx:{pb:10},children:[s.jsx(C,{position:"sticky",sx:{bgcolor:ne[b].color},children:s.jsxs(W,{children:[s.jsx(p,{edge:"start",color:"inherit",onClick:()=>{window.history.back()},sx:{mr:2},children:s.jsx(E,{})}),s.jsx(d,{variant:"h6",sx:{flexGrow:1},children:ne[b].label}),s.jsx(R,{color:"inherit",startIcon:s.jsx(Q,{}),onClick:async()=>{if(0!==F.length){re(!0),i(""),u("");try{const e={type:b,date:(new Date).toISOString(),items:F.map(e=>({productId:e.productId,productName:e.productName,quantity:e.quantity,unit:e.unit,unitPrice:e.unitPrice,totalValue:e.totalValue,reason:e.reason||X||"无"})),totalQuantity:F.reduce((e,t)=>e+t.quantity,0),totalValue:F.reduce((e,t)=>e+t.totalValue,0)},t=await fetch("/api/production-loss/register",{method:"POST",headers:{"Content-Type":"application/json","x-current-store-id":j},body:JSON.stringify(e)});if(!t.ok)throw new Error("提交报损记录失败");const s=await t.json();if(!s.success)throw new Error(s.message||"提交报损记录失败");u("报损记录提交成功！"),B([]),Y(""),setTimeout(()=>{window.history.back()},3e3)}catch(e){i(e instanceof Error?e.message:"提交报损记录失败")}finally{re(!1)}}else i("请至少添加一个报损项目")},disabled:se||0===F.length,children:"提交"})]})}),s.jsxs(o,{maxWidth:"sm",sx:{py:2},children:[n&&s.jsx(x,{severity:"error",sx:{mb:2},onClose:()=>i(""),children:n}),a&&s.jsx(x,{severity:"success",sx:{mb:2},children:a}),s.jsx(h,{elevation:2,sx:{p:2,mb:2},children:s.jsxs(P,{fullWidth:!0,size:"small",children:[s.jsx(q,{children:"报损类型"}),s.jsx(A,{value:b,label:"报损类型",onChange:e=>v(e.target.value),children:Object.entries(ne).map(([e,t])=>s.jsx(D,{value:e,children:t.label},e))})]})}),s.jsx(h,{elevation:2,sx:{p:2,mb:2},children:s.jsx(_,{fullWidth:!0,label:"报损原因（可选）",value:X,onChange:e=>Y(e.target.value),placeholder:"输入报损原因，将应用到所有项目",multiline:!0,rows:2})}),F.length>0&&s.jsxs(h,{elevation:2,sx:{mb:2},children:[s.jsx(l,{sx:{p:2,borderBottom:"1px solid #e0e0e0"},children:s.jsxs(d,{variant:"h6",children:["报损项目列表 (",F.length,")"]})}),s.jsx(O,{children:F.map((e,t)=>s.jsxs($.Fragment,{children:[s.jsxs(z,{children:[s.jsx(N,{primary:e.productName,secondary:s.jsxs(l,{children:[s.jsxs(d,{variant:"body2",color:"text.secondary",children:["单价: ¥",e.unitPrice.toFixed(2),"/",e.unit]}),s.jsxs(l,{sx:{mt:1,display:"flex",alignItems:"center",gap:1},children:[s.jsx(R,{size:"small",onClick:()=>oe(e.productId,e.quantity-1),children:"-"}),s.jsx(d,{variant:"body2",sx:{minWidth:"40px",textAlign:"center"},children:e.quantity}),s.jsx(R,{size:"small",onClick:()=>oe(e.productId,e.quantity+1),children:"+"}),s.jsxs(d,{variant:"body2",sx:{ml:2},children:["小计: ¥",e.totalValue.toFixed(2)]})]}),s.jsx(_,{size:"small",placeholder:"报损原因",value:e.reason,onChange:t=>{return s=e.productId,r=t.target.value,void B(e=>e.map(e=>e.productId===s?{...e,reason:r}:e));var s,r},sx:{mt:1,width:"100%"}})]})}),s.jsx(K,{children:s.jsx(p,{edge:"end",onClick:()=>le(e.productId),color:"error",children:s.jsx(Z,{})})})]}),t<F.length-1&&s.jsx(g,{})]},e.productId))}),s.jsx(l,{sx:{p:2,bgcolor:"#f5f5f5",borderTop:"1px solid #e0e0e0"},children:s.jsxs(f,{container:!0,spacing:2,children:[s.jsx(f,{item:!0,xs:6,children:s.jsxs(d,{variant:"subtitle2",children:["总数量: ",ce]})}),s.jsx(f,{item:!0,xs:6,children:s.jsxs(d,{variant:"subtitle2",sx:{textAlign:"right"},children:["总价值: ¥",de.toFixed(2)]})})]})})]}),0===F.length&&s.jsxs(h,{elevation:2,sx:{p:4,textAlign:"center",mb:2},children:[s.jsx(d,{color:"text.secondary",sx:{mb:2},children:"暂无报损项目"}),s.jsx(d,{variant:"body2",color:"text.secondary",children:"点击右下角的 + 按钮添加报损项目"})]})]}),s.jsx(ee,{color:"primary",sx:{position:"fixed",bottom:16,right:16,bgcolor:ne[b].color,"&:hover":{bgcolor:ne[b].color,opacity:.8}},onClick:()=>I(!0),children:s.jsx(U,{})}),s.jsxs(H,{open:S,onClose:()=>I(!1),fullWidth:!0,maxWidth:"sm",PaperProps:{sx:{height:"80vh"}},children:[s.jsx(T,{children:"选择产品"}),s.jsxs(M,{children:[s.jsx(_,{fullWidth:!0,placeholder:"搜索产品名称",value:L,onChange:e=>V(e.target.value),sx:{mb:2},InputProps:{startAdornment:s.jsx(te,{position:"start",children:s.jsx(G,{})})}}),e?s.jsx(l,{sx:{display:"flex",justifyContent:"center",py:4},children:s.jsx(c,{})}):s.jsxs(O,{children:[ae.map(e=>{var t;return s.jsxs(z,{button:!0,onClick:()=>(e=>{if(F.find(t=>t.productId===e._id))B(t=>t.map(t=>t.productId===e._id?{...t,quantity:t.quantity+1,totalValue:(t.quantity+1)*t.unitPrice}:t));else{const t={productId:e._id,productName:e.name,quantity:1,unit:e.unit||"个",unitPrice:e.price||0,totalValue:e.price||0,reason:X||""};B(e=>[...e,t])}I(!1),V("")})(e),children:[s.jsx(N,{primary:e.name,secondary:`¥${(null==(t=e.price)?void 0:t.toFixed(2))||"0.00"}/${e.unit||"个"}`}),e.category&&s.jsx(m,{label:e.category,size:"small",variant:"outlined"})]},e._id)}),0===ae.length&&s.jsx(l,{sx:{py:4,textAlign:"center"},children:s.jsx(d,{color:"text.secondary",children:L?"未找到匹配的产品":"暂无产品数据"})})]})]}),s.jsx(J,{children:s.jsx(R,{onClick:()=>I(!1),children:"取消"})})]})]}):s.jsx(o,{maxWidth:"sm",sx:{py:4},children:s.jsx(x,{severity:"warning",children:"无法获取门店信息，请检查URL参数或重新登录。"})})};!function(){const e=new URLSearchParams(window.location.search),t=e.get("storeId")||e.get("store");t&&sessionStorage.setItem("lockedStoreId",t)}();const me=window.fetch;window.fetch=function(e,t){const s=sessionStorage.getItem("lockedStoreId"),r=localStorage.getItem("defaultStoreId"),n=s||r,i={...t};return i.headers||(i.headers={}),n&&!i.headers["x-current-store-id"]&&(i.headers["x-current-store-id"]=n),me(e,i)};const pe=()=>s.jsx(re,{future:{v7_startTransition:!0,v7_relativeSplatPath:!0},children:s.jsx("div",{className:"mobile-app",children:s.jsxs(ne,{children:[s.jsx(ie,{path:"/",element:s.jsx(he,{})}),s.jsx(ie,{path:"/mobileHome",element:s.jsx(he,{})}),s.jsx(ie,{path:"/mobileHome/production-loss",element:s.jsx(ue,{})}),s.jsx(ie,{path:"/mobileHome/loss-register",element:s.jsx(je,{})})]})})});e.createRoot(document.getElementById("root")).render(s.jsx($.StrictMode,{children:s.jsx(pe,{})}));
