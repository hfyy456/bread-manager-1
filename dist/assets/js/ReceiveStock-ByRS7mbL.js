import{r as t,j as e,b as i,T as a,P as s,g as n,ac as r,v as l,w as o,x as d,y as c,z as u,H as h,Y as x,m as j,I as m,aJ as p,B as g,aK as v,bw as f,S as y,a as w,A as b}from"./mui-DEqbSeLr.js";import{D as C,r as S,u as k,v as q}from"./main-DfHVpnND.js";import"./vendor-Cfs_Iq82.js";import"./client-BoWZ1c0e.js";import"./router-BkWWz-Xj.js";import"./ExpandMore-DsgsTLRe.js";import"./utils-B4UiVrbL.js";import"./zh-CN-KEGYwzZz.js";const N=w.forwardRef(function(t,i){return e.jsx(b,{elevation:6,ref:i,variant:"filled",...t})}),z=()=>{const{ingredients:w,ingredientsMap:b,updateIngredientStock:z}=t.useContext(C),[I,B]=t.useState([]),[E,A]=t.useState(!1),F=t.useRef(null),[O,R]=t.useState(!1),[W,D]=t.useState(""),[H,M]=t.useState("info"),T=(t,e="info")=>{D(t),M(e),R(!0)},$=(t,e)=>{"clickaway"!==e&&R(!1)},_=t=>{B(e=>e.filter(e=>e.id!==t))};return e.jsxs(i,{maxWidth:"lg",sx:{py:4},children:[e.jsx(a,{variant:"h4",component:"h1",gutterBottom:!0,children:"收货入库"}),e.jsxs(s,{elevation:3,sx:{p:3,mb:4},children:[e.jsx(a,{variant:"h6",gutterBottom:!0,children:"1. 导入采购单"}),e.jsx(n,{variant:"contained",startIcon:e.jsx(r,{}),onClick:()=>F.current.click(),children:"导入Excel"}),e.jsx("input",{type:"file",ref:F,onChange:t=>{const e=t.target.files[0];if(!e)return;const i=new FileReader;i.onload=t=>{try{const e=t.target.result,i=S(e,{type:"array"}),a=i.SheetNames[0],s=i.Sheets[a],n=k.sheet_to_json(s),r=["原料名称","建议采购数量","建议采购单位"],l=Object.keys(n[0]||{});if(!r.every(t=>l.includes(t)))return void T(`Excel文件必须包含以下列: ${r.join(", ")}`,"error");const o=n.map((t,e)=>({id:e,name:t["原料名称"],quantity:t["建议采购数量"],unit:t["建议采购单位"],location:"10",status:b.has(t["原料名称"])?"valid":"invalid"})).filter(t=>"无需采购"!==t.quantity&&t.quantity>0).filter(t=>"valid"===t.status);B(o),0===o.length&&T("未在文件中找到有效的待入库原料。","info")}catch(e){T("文件处理失败，请检查格式。","error")}},i.readAsArrayBuffer(e),F.current&&(F.current.value="")},accept:".xlsx, .xls",style:{display:"none"}})]}),I.length>0&&e.jsxs(s,{elevation:3,sx:{p:3},children:[e.jsx(a,{variant:"h6",gutterBottom:!0,children:"2. 确认入库信息"}),e.jsx(l,{children:e.jsxs(o,{children:[e.jsx(d,{children:e.jsxs(c,{children:[e.jsx(u,{sx:{minWidth:"200px"},children:"原料名称"}),e.jsx(u,{align:"right",children:"采购数量"}),e.jsx(u,{align:"right",children:"单位"}),e.jsx(u,{align:"right",children:"入库库位"}),e.jsx(u,{align:"center",children:"操作"})]})}),e.jsx(h,{children:I.map(t=>e.jsxs(c,{sx:{backgroundColor:"invalid"===t.status?"rgba(255, 229, 229, 0.6)":"inherit","&:last-child td, &:last-child th":{border:0}},children:[e.jsx(u,{component:"th",scope:"row",children:t.isNew?e.jsx(x,{fullWidth:!0,options:w,getOptionLabel:t=>t.name||"",isOptionEqualToValue:(t,e)=>t.id===e.id,onChange:(e,i)=>{var a,s;a=t.id,(s=i)?B(t=>t.map(t=>t.id===a?{...t,name:s.name,unit:s.unit,status:"valid",isNew:!1}:t)):_(a)},renderInput:t=>e.jsx(j,{...t,label:"搜索原料",size:"small",variant:"standard"})}):e.jsxs(e.Fragment,{children:[t.name," ","invalid"===t.status&&e.jsx(a,{variant:"caption",color:"error",children:"(未找到)"})]})}),e.jsx(u,{align:"right",children:e.jsx(j,{size:"small",variant:"outlined",type:"number",value:t.quantity,onChange:e=>((t,e)=>{const i=parseFloat(e);B(e=>e.map(e=>e.id===t?{...e,quantity:isNaN(i)?"":i}:e))})(t.id,e.target.value),sx:{width:"100px"},disabled:"invalid"===t.status||t.isNew})}),e.jsx(u,{align:"right",children:t.unit}),e.jsx(u,{align:"right",children:t.location}),e.jsx(u,{align:"center",children:e.jsx(m,{"aria-label":"delete",onClick:()=>_(t.id),size:"small",children:e.jsx(p,{fontSize:"small"})})})]},t.id))})]})}),e.jsxs(g,{sx:{mt:3,display:"flex",justifyContent:"flex-end",gap:2},children:[e.jsx(n,{variant:"outlined",startIcon:e.jsx(v,{}),onClick:()=>{B(t=>[...t,{id:q(),name:"",quantity:0,unit:"",location:"10",status:"new",isNew:!0}])},children:"手动添加原料"}),e.jsx(n,{variant:"contained",color:"primary",size:"large",startIcon:e.jsx(f,{}),onClick:async()=>{A(!0);const t=I.filter(t=>"valid"===t.status).map(t=>({ingredientName:t.name,location:t.location,quantity:t.quantity,unit:t.unit}));if(0===t.length)return T("没有可确认入库的有效原料。","warning"),void A(!1);const e=await z(t);e.success?(T("库存更新成功！","success"),B([])):T(`库存更新失败: ${e.message}`,"error"),A(!1)},disabled:E||I.every(t=>"invalid"===t.status),children:E?"处理中...":"确认入-库"})]})]}),e.jsx(y,{open:O,autoHideDuration:6e3,onClose:$,children:e.jsx(N,{onClose:$,severity:H,sx:{width:"100%"},children:W})})]})};export{z as default};
