import{O as _,j as e,r as o,ab as L,ad as x,P as q,ai as f,aj as N,I as Q,ac as V,a9 as G,a7 as J,a8 as K}from"./AdapterDateFns-C_xc8QeI.js";import{l as X,F as Y,d as Z,e as ee,f as te,g as A,h as r,j as ae,A as ne,m as se,n as re,r as ie,o as le,p as oe}from"./main-Du2cz2Fj.js";const ce=_(e.jsx("path",{d:"M2.01 21 23 12 2.01 3 2 10l15 2-15 2z"}),"Send"),de=J.forwardRef(function(j,p){return e.jsx(K,{elevation:6,ref:p,variant:"filled",...j})}),xe=()=>{const{ingredients:v,ingredientsMap:j,updateIngredientStock:p}=o.useContext(X),[u,c]=o.useState([]),[y,g]=o.useState(!1),h=o.useRef(null),[R,b]=o.useState(!1),[T,B]=o.useState(""),[O,F]=o.useState("info"),d=(t,a="info")=>{B(t),F(a),b(!0)},S=(t,a)=>{a!=="clickaway"&&b(!1)},z=t=>{const a=t.target.files[0];if(!a)return;const n=new FileReader;n.onload=i=>{try{const l=i.target.result,m=ie(l,{type:"array"}),H=m.SheetNames[0],W=m.Sheets[H],C=le.sheet_to_json(W),w=["原料名称","建议采购数量","建议采购单位"],$=Object.keys(C[0]||{});if(!w.every(s=>$.includes(s))){d(`Excel文件必须包含以下列: ${w.join(", ")}`,"error");return}const I=C.map((s,U)=>({id:U,name:s.原料名称,quantity:s.建议采购数量,unit:s.建议采购单位,location:"10",status:j.has(s.原料名称)?"valid":"invalid"})).filter(s=>s.quantity!=="无需采购"&&s.quantity>0).filter(s=>s.status==="valid");c(I),I.length===0&&d("未在文件中找到有效的待入库原料。","info")}catch(l){console.error("文件处理失败:",l),d("文件处理失败，请检查格式。","error")}},n.readAsArrayBuffer(a),h.current&&(h.current.value="")},D=(t,a)=>{const n=parseFloat(a);c(i=>i.map(l=>l.id===t?{...l,quantity:isNaN(n)?"":n}:l))},E=()=>{c(t=>[...t,{id:oe(),name:"",quantity:0,unit:"",location:"10",status:"new",isNew:!0}])},P=(t,a)=>{if(!a){k(t);return}c(n=>n.map(i=>i.id===t?{...i,name:a.name,unit:a.unit,status:"valid",isNew:!1}:i))},k=t=>{c(a=>a.filter(n=>n.id!==t))},M=async()=>{g(!0);const t=u.filter(n=>n.status==="valid").map(n=>({ingredientName:n.name,location:n.location,quantity:n.quantity,unit:n.unit}));if(t.length===0){d("没有可确认入库的有效原料。","warning"),g(!1);return}const a=await p(t);a.success?(d("库存更新成功！","success"),c([])):d(`库存更新失败: ${a.message}`,"error"),g(!1)};return e.jsxs(L,{maxWidth:"lg",sx:{py:4},children:[e.jsx(x,{variant:"h4",component:"h1",gutterBottom:!0,children:"收货入库"}),e.jsxs(q,{elevation:3,sx:{p:3,mb:4},children:[e.jsx(x,{variant:"h6",gutterBottom:!0,children:"1. 导入采购单"}),e.jsx(f,{variant:"contained",startIcon:e.jsx(Y,{}),onClick:()=>h.current.click(),children:"导入Excel"}),e.jsx("input",{type:"file",ref:h,onChange:z,accept:".xlsx, .xls",style:{display:"none"}})]}),u.length>0&&e.jsxs(q,{elevation:3,sx:{p:3},children:[e.jsx(x,{variant:"h6",gutterBottom:!0,children:"2. 确认入库信息"}),e.jsx(Z,{children:e.jsxs(ee,{children:[e.jsx(te,{children:e.jsxs(A,{children:[e.jsx(r,{sx:{minWidth:"200px"},children:"原料名称"}),e.jsx(r,{align:"right",children:"采购数量"}),e.jsx(r,{align:"right",children:"单位"}),e.jsx(r,{align:"right",children:"入库库位"}),e.jsx(r,{align:"center",children:"操作"})]})}),e.jsx(ae,{children:u.map(t=>e.jsxs(A,{sx:{backgroundColor:t.status==="invalid"?"rgba(255, 229, 229, 0.6)":"inherit","&:last-child td, &:last-child th":{border:0}},children:[e.jsx(r,{component:"th",scope:"row",children:t.isNew?e.jsx(ne,{fullWidth:!0,options:v,getOptionLabel:a=>a.name||"",isOptionEqualToValue:(a,n)=>a.id===n.id,onChange:(a,n)=>{P(t.id,n)},renderInput:a=>e.jsx(N,{...a,label:"搜索原料",size:"small",variant:"standard"})}):e.jsxs(e.Fragment,{children:[t.name," ",t.status==="invalid"&&e.jsx(x,{variant:"caption",color:"error",children:"(未找到)"})]})}),e.jsx(r,{align:"right",children:e.jsx(N,{size:"small",variant:"outlined",type:"number",value:t.quantity,onChange:a=>D(t.id,a.target.value),sx:{width:"100px"},disabled:t.status==="invalid"||t.isNew})}),e.jsx(r,{align:"right",children:t.unit}),e.jsx(r,{align:"right",children:t.location}),e.jsx(r,{align:"center",children:e.jsx(Q,{"aria-label":"delete",onClick:()=>k(t.id),size:"small",children:e.jsx(se,{fontSize:"small"})})})]},t.id))})]})}),e.jsxs(V,{sx:{mt:3,display:"flex",justifyContent:"flex-end",gap:2},children:[e.jsx(f,{variant:"outlined",startIcon:e.jsx(re,{}),onClick:E,children:"手动添加原料"}),e.jsx(f,{variant:"contained",color:"primary",size:"large",startIcon:e.jsx(ce,{}),onClick:M,disabled:y||u.every(t=>t.status==="invalid"),children:y?"处理中...":"确认入-库"})]})]}),e.jsx(G,{open:R,autoHideDuration:6e3,onClose:S,children:e.jsx(de,{onClose:S,severity:O,sx:{width:"100%"},children:T})})]})};export{xe as default};
