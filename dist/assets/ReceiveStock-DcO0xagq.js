import{V,j as e,r as o,ac as _,ae as x,P as q,af as f,au as N,J,ad as L,aa as Q,a8 as G,a9 as K}from"./format-Cn00hWB_.js";import{l as X,F as Y,d as Z,e as ee,f as ae,g as A,h as r,j as te,A as ne,m as se,n as re,r as ie,o as le,p as oe}from"./main-DECMxSee.js";const ce=V(e.jsx("path",{d:"M2.01 21 23 12 2.01 3 2 10l15 2-15 2z"}),"Send"),de=G.forwardRef(function(p,j){return e.jsx(K,{elevation:6,ref:j,variant:"filled",...p})}),xe=()=>{const{ingredients:v,ingredientsMap:p,updateIngredientStock:j}=o.useContext(X),[u,c]=o.useState([]),[y,g]=o.useState(!1),h=o.useRef(null),[R,S]=o.useState(!1),[T,B]=o.useState(""),[F,O]=o.useState("info"),d=(a,t="info")=>{B(a),O(t),S(!0)},b=(a,t)=>{t!=="clickaway"&&S(!1)},z=a=>{const t=a.target.files[0];if(!t)return;const n=new FileReader;n.onload=i=>{try{const l=i.target.result,m=ie(l,{type:"array"}),H=m.SheetNames[0],W=m.Sheets[H],C=le.sheet_to_json(W),w=["原料名称","建议采购数量","建议采购单位"],$=Object.keys(C[0]||{});if(!w.every(s=>$.includes(s))){d(`Excel文件必须包含以下列: ${w.join(", ")}`,"error");return}const I=C.map((s,U)=>({id:U,name:s.原料名称,quantity:s.建议采购数量,unit:s.建议采购单位,location:"10",status:p.has(s.原料名称)?"valid":"invalid"})).filter(s=>s.quantity!=="无需采购"&&s.quantity>0).filter(s=>s.status==="valid");c(I),I.length===0&&d("未在文件中找到有效的待入库原料。","info")}catch(l){console.error("文件处理失败:",l),d("文件处理失败，请检查格式。","error")}},n.readAsArrayBuffer(t),h.current&&(h.current.value="")},D=(a,t)=>{const n=parseFloat(t);c(i=>i.map(l=>l.id===a?{...l,quantity:isNaN(n)?"":n}:l))},E=()=>{c(a=>[...a,{id:oe(),name:"",quantity:0,unit:"",location:"10",status:"new",isNew:!0}])},P=(a,t)=>{if(!t){k(a);return}c(n=>n.map(i=>i.id===a?{...i,name:t.name,unit:t.unit,status:"valid",isNew:!1}:i))},k=a=>{c(t=>t.filter(n=>n.id!==a))},M=async()=>{g(!0);const a=u.filter(n=>n.status==="valid").map(n=>({ingredientName:n.name,location:n.location,quantity:n.quantity,unit:n.unit}));if(a.length===0){d("没有可确认入库的有效原料。","warning"),g(!1);return}const t=await j(a);t.success?(d("库存更新成功！","success"),c([])):d(`库存更新失败: ${t.message}`,"error"),g(!1)};return e.jsxs(_,{maxWidth:"lg",sx:{py:4},children:[e.jsx(x,{variant:"h4",component:"h1",gutterBottom:!0,children:"收货入库"}),e.jsxs(q,{elevation:3,sx:{p:3,mb:4},children:[e.jsx(x,{variant:"h6",gutterBottom:!0,children:"1. 导入采购单"}),e.jsx(f,{variant:"contained",startIcon:e.jsx(Y,{}),onClick:()=>h.current.click(),children:"导入Excel"}),e.jsx("input",{type:"file",ref:h,onChange:z,accept:".xlsx, .xls",style:{display:"none"}})]}),u.length>0&&e.jsxs(q,{elevation:3,sx:{p:3},children:[e.jsx(x,{variant:"h6",gutterBottom:!0,children:"2. 确认入库信息"}),e.jsx(Z,{children:e.jsxs(ee,{children:[e.jsx(ae,{children:e.jsxs(A,{children:[e.jsx(r,{sx:{minWidth:"200px"},children:"原料名称"}),e.jsx(r,{align:"right",children:"采购数量"}),e.jsx(r,{align:"right",children:"单位"}),e.jsx(r,{align:"right",children:"入库库位"}),e.jsx(r,{align:"center",children:"操作"})]})}),e.jsx(te,{children:u.map(a=>e.jsxs(A,{sx:{backgroundColor:a.status==="invalid"?"rgba(255, 229, 229, 0.6)":"inherit","&:last-child td, &:last-child th":{border:0}},children:[e.jsx(r,{component:"th",scope:"row",children:a.isNew?e.jsx(ne,{fullWidth:!0,options:v,getOptionLabel:t=>t.name||"",isOptionEqualToValue:(t,n)=>t.id===n.id,onChange:(t,n)=>{P(a.id,n)},renderInput:t=>e.jsx(N,{...t,label:"搜索原料",size:"small",variant:"standard"})}):e.jsxs(e.Fragment,{children:[a.name," ",a.status==="invalid"&&e.jsx(x,{variant:"caption",color:"error",children:"(未找到)"})]})}),e.jsx(r,{align:"right",children:e.jsx(N,{size:"small",variant:"outlined",type:"number",value:a.quantity,onChange:t=>D(a.id,t.target.value),sx:{width:"100px"},disabled:a.status==="invalid"||a.isNew})}),e.jsx(r,{align:"right",children:a.unit}),e.jsx(r,{align:"right",children:a.location}),e.jsx(r,{align:"center",children:e.jsx(J,{"aria-label":"delete",onClick:()=>k(a.id),size:"small",children:e.jsx(se,{fontSize:"small"})})})]},a.id))})]})}),e.jsxs(L,{sx:{mt:3,display:"flex",justifyContent:"flex-end",gap:2},children:[e.jsx(f,{variant:"outlined",startIcon:e.jsx(re,{}),onClick:E,children:"手动添加原料"}),e.jsx(f,{variant:"contained",color:"primary",size:"large",startIcon:e.jsx(ce,{}),onClick:M,disabled:y||u.every(a=>a.status==="invalid"),children:y?"处理中...":"确认入-库"})]})]}),e.jsx(Q,{open:R,autoHideDuration:6e3,onClose:b,children:e.jsx(de,{onClose:b,severity:F,sx:{width:"100%"},children:T})})]})};export{xe as default};
