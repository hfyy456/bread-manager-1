<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>库存数据测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .stats { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .ingredient { border: 1px solid #ddd; margin: 5px 0; padding: 10px; border-radius: 3px; }
        .ingredient.has-stock { background-color: #e8f5e8; border-color: #4caf50; }
        .debug { background: #fff3cd; padding: 10px; margin: 10px 0; border-radius: 3px; font-family: monospace; font-size: 12px; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>库存数据测试页面</h1>
        
        <div>
            <button onclick="testAPI()">测试API</button>
            <button onclick="clearResults()">清除结果</button>
        </div>
        
        <div id="stats" class="stats" style="display: none;">
            <h3>统计信息</h3>
            <div id="statsContent"></div>
        </div>
        
        <div id="debug" class="debug" style="display: none;">
            <h3>调试信息</h3>
            <pre id="debugContent"></pre>
        </div>
        
        <div id="results"></div>
    </div>

    <script>
        async function testAPI() {
            const resultsDiv = document.getElementById('results');
            const statsDiv = document.getElementById('stats');
            const debugDiv = document.getElementById('debug');
            const statsContent = document.getElementById('statsContent');
            const debugContent = document.getElementById('debugContent');
            
            resultsDiv.innerHTML = '<p>正在获取数据...</p>';
            
            try {
                const response = await fetch('/api/ingredients/list', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-current-store-id': '6878def4ae6e08fa4af88e34'
                    },
                    body: JSON.stringify({})
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success && Array.isArray(result.data)) {
                    const ingredients = result.data;
                    
                    // 统计信息
                    let totalIngredients = ingredients.length;
                    let itemsWithMainStock = 0;
                    let itemsWithPostStock = 0;
                    let itemsWithAnyStock = 0;
                    
                    const itemsWithStock = [];
                    
                    ingredients.forEach(ingredient => {
                        const mainStock = ingredient.mainWarehouseStock?.quantity || 0;
                        let postStock = 0;
                        
                        if (ingredient.stockByPost && typeof ingredient.stockByPost === 'object') {
                            Object.values(ingredient.stockByPost).forEach(stock => {
                                if (stock && typeof stock.quantity === 'number' && stock.quantity > 0) {
                                    postStock += stock.quantity;
                                }
                            });
                        }
                        
                        if (mainStock > 0) itemsWithMainStock++;
                        if (postStock > 0) itemsWithPostStock++;
                        if (mainStock > 0 || postStock > 0) {
                            itemsWithAnyStock++;
                            itemsWithStock.push({
                                ...ingredient,
                                calculatedMainStock: mainStock,
                                calculatedPostStock: postStock,
                                calculatedTotalStock: mainStock + postStock
                            });
                        }
                    });
                    
                    // 显示统计信息
                    statsContent.innerHTML = `
                        <p><strong>总原料数:</strong> ${totalIngredients}</p>
                        <p><strong>有主仓库存:</strong> ${itemsWithMainStock}</p>
                        <p><strong>有岗位库存:</strong> ${itemsWithPostStock}</p>
                        <p><strong>有任何库存:</strong> ${itemsWithAnyStock}</p>
                    `;
                    statsDiv.style.display = 'block';
                    
                    // 显示调试信息
                    debugContent.textContent = JSON.stringify({
                        apiResponse: {
                            success: result.success,
                            dataLength: result.data.length
                        },
                        firstThreeItems: ingredients.slice(0, 3).map(item => ({
                            name: item.name,
                            mainWarehouseStock: item.mainWarehouseStock,
                            stockByPost: item.stockByPost
                        })),
                        firstThreeWithStock: itemsWithStock.slice(0, 3).map(item => ({
                            name: item.name,
                            mainStock: item.calculatedMainStock,
                            postStock: item.calculatedPostStock,
                            totalStock: item.calculatedTotalStock,
                            stockByPost: item.stockByPost
                        }))
                    }, null, 2);
                    debugDiv.style.display = 'block';
                    
                    // 显示有库存的原料
                    if (itemsWithStock.length > 0) {
                        resultsDiv.innerHTML = `
                            <h3>有库存的原料 (前20个)</h3>
                            ${itemsWithStock.slice(0, 20).map(item => `
                                <div class="ingredient has-stock">
                                    <h4>${item.name}</h4>
                                    <p><strong>主仓库存:</strong> ${item.calculatedMainStock} ${item.unit}</p>
                                    <p><strong>岗位库存:</strong> ${item.calculatedPostStock} ${item.unit}</p>
                                    <p><strong>总库存:</strong> ${item.calculatedTotalStock} ${item.unit}</p>
                                    <p><strong>价格:</strong> ¥${item.price || 0}</p>
                                    <p><strong>总价值:</strong> ¥${(item.calculatedTotalStock * (item.price || 0)).toFixed(2)}</p>
                                    <details>
                                        <summary>岗位库存详情</summary>
                                        <pre>${JSON.stringify(item.stockByPost, null, 2)}</pre>
                                    </details>
                                </div>
                            `).join('')}
                        `;
                    } else {
                        resultsDiv.innerHTML = '<p style="color: red;">没有找到有库存的原料！</p>';
                    }
                    
                } else {
                    resultsDiv.innerHTML = `<p style="color: red;">API错误: ${result.message || '未知错误'}</p>`;
                }
                
            } catch (error) {
                resultsDiv.innerHTML = `<p style="color: red;">请求失败: ${error.message}</p>`;
                console.error('API测试错误:', error);
            }
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('stats').style.display = 'none';
            document.getElementById('debug').style.display = 'none';
        }
        
        // 页面加载时自动测试
        window.onload = function() {
            testAPI();
        };
    </script>
</body>
</html>